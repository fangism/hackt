--- FILENAME.orig	Sun Mar  2 15:30:27 2008
+++ FILENAME	Sun Mar  2 15:36:15 2008
@@ -1,3 +1,4 @@
+#if	defined(KEEP_FLEX_COMMON) || 1
 /* A lexical scanner generated by flex */
 
 /* Scanner skeleton version:
@@ -104,10 +105,12 @@
 #define YY_BUF_SIZE 16384
 
 typedef struct yy_buffer_state *YY_BUFFER_STATE;
+#endif	// KEEP_FLEX_COMMON
 
 extern int yyleng;
 extern FILE *yyin, *yyout;
 
+#if	defined(KEEP_FLEX_COMMON) || 1
 #define EOB_ACT_CONTINUE_SCAN 0
 #define EOB_ACT_END_OF_FILE 1
 #define EOB_ACT_LAST_MATCH 2
@@ -141,13 +144,13 @@
 
 #define unput(c) yyunput( c, yytext_ptr )
 
+#ifndef	FLEX_STRUCT_BUFFER_STATE
 /* The following is because we cannot portably get our hands on size_t
  * (without autoconf's help, which isn't available because we want
  * flex-generated scanners to compile on their own).
  */
 typedef unsigned int yy_size_t;
 
-
 struct yy_buffer_state
 	{
 	FILE *yy_input_file;
@@ -204,6 +207,8 @@
 	 */
 #define YY_BUFFER_EOF_PENDING 2
 	};
+#endif	// FLEX_STRUCT_BUFFER_STATE
+#endif	// KEEP_FLEX_COMMON
 
 static YY_BUFFER_STATE yy_current_buffer = 0;
 
@@ -232,23 +237,37 @@
  */
 static int yy_did_buffer_switch_on_eof;
 
+#if	defined(KEEP_FLEX_COMMON) || 1
+extern
 void yyrestart YY_PROTO(( FILE *input_file ));
 
+extern
 void yy_switch_to_buffer YY_PROTO(( YY_BUFFER_STATE new_buffer ));
+extern
 void yy_load_buffer_state YY_PROTO(( void ));
+extern
 YY_BUFFER_STATE yy_create_buffer YY_PROTO(( FILE *file, int size ));
+extern
 void yy_delete_buffer YY_PROTO(( YY_BUFFER_STATE b ));
+extern
 void yy_init_buffer YY_PROTO(( YY_BUFFER_STATE b, FILE *file ));
+extern
 void yy_flush_buffer YY_PROTO(( YY_BUFFER_STATE b ));
 #define YY_FLUSH_BUFFER yy_flush_buffer( yy_current_buffer )
 
+extern
 YY_BUFFER_STATE yy_scan_buffer YY_PROTO(( char *base, yy_size_t size ));
+extern
 YY_BUFFER_STATE yy_scan_string YY_PROTO(( yyconst char *yy_str ));
+extern
 YY_BUFFER_STATE yy_scan_bytes YY_PROTO(( yyconst char *bytes, int len ));
 
-static void *yy_flex_alloc YY_PROTO(( yy_size_t ));
-static void *yy_flex_realloc YY_PROTO(( void *, yy_size_t )) __unused;
-static void yy_flex_free YY_PROTO(( void * ));
+extern
+void *yy_flex_alloc YY_PROTO(( yy_size_t ));
+extern
+void *yy_flex_realloc YY_PROTO(( void *, yy_size_t )) __unused;
+extern
+void yy_flex_free YY_PROTO(( void * ));
 
 #define yy_new_buffer yy_create_buffer
 
@@ -267,17 +286,25 @@
 	}
 
 #define YY_AT_BOL() (yy_current_buffer->yy_at_bol)
+#endif	// KEEP_FLEX_COMMON
 
 typedef unsigned char YY_CHAR;
 FILE *yyin = (FILE *) 0, *yyout = (FILE *) 0;
 typedef int yy_state_type;
 extern char *yytext;
+#if	defined(KEEP_FLEX_COMMON) || 1
 #define yytext_ptr yytext
+#endif	// KEEP_FLEX_COMMON
 
+/* yy_get_previous_state differs but some constant values ... */
 static yy_state_type yy_get_previous_state YY_PROTO(( void ));
 static yy_state_type yy_try_NUL_trans YY_PROTO(( yy_state_type current_state ));
-static int yy_get_next_buffer YY_PROTO(( void ));
-static void yy_fatal_error YY_PROTO(( yyconst char msg[] ));
+#if	defined(KEEP_FLEX_COMMON) || 1
+extern
+int yy_get_next_buffer YY_PROTO(( void ));
+extern
+void yy_fatal_error YY_PROTO(( yyconst char msg[] ));
+#endif	// KEEP_FLEX_COMMON
 
 /* Done after the current pattern has been matched and before the
  * corresponding action - sets up yytext.
@@ -391,6 +418,7 @@
 static yy_state_type yy_last_accepting_state;
 static char *yy_last_accepting_cpos;
 
+#if	defined(KEEP_FLEX_COMMON) || 1
 /* The intent behind this definition is that it'll catch
  * any uses of REJECT which flex missed.
  */
@@ -398,6 +426,7 @@
 #define yymore() yymore_used_but_not_detected
 #define YY_MORE_ADJ 0
 #define YY_RESTORE_YY_MORE_OFFSET
+#endif	// KEEP_FLEX_COMMON
 char *yytext;
 #line 1 "instref-lex.ll"
 #define INITIAL 0
@@ -515,6 +544,7 @@
 	macros in the generated source file, because I've turned on
 	-Wundef for all translation units.  
  */
+#if	defined(KEEP_FLEX_COMMON) || 1
 #define YY_NEVER_INTERACTIVE 1
 #define YY_MAIN 0
 #define YY_STACK_USED 0
@@ -643,6 +673,7 @@
 #ifndef YY_FATAL_ERROR
 #define YY_FATAL_ERROR(msg) yy_fatal_error( msg )
 #endif
+#endif	// KEEP_FLEX_COMMON
 
 /* Default declaration of generated scanner - a define so the user can
  * easily add parameters.
@@ -1000,6 +1031,7 @@
 	} /* end of yylex */
 
 
+#ifdef	KEEP_FLEX_COMMON
 /* yy_get_next_buffer - try to read in a new buffer
  *
  * Returns a code representing an action:
@@ -1136,6 +1168,7 @@
 
 	return ret_val;
 	}
+#endif	// KEEP_FLEX_COMMON
 
 
 /* yy_get_previous_state - get the state just before the EOB char was reached */
@@ -1202,6 +1235,9 @@
 	return yy_is_jam ? 0 : yy_current_state;
 	}
 
+/* patch: extract common procedures and share among multiple lexers */
+#ifdef	KEEP_FLEX_COMMON
+/* change these protypes to have external linkage in post-processing */
 
 #ifndef YY_NO_UNPUT
 #ifdef YY_USE_PROTOS
@@ -1744,6 +1780,8 @@
 	{
 	free( ptr );
 	}
+
+#endif	// KEEP_FLEX_COMMON
 
 #if YY_MAIN
 int main()
