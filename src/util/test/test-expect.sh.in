#!@SH_PATH@
# "test-expect.sh.in"
#	$Id: test-expect.sh.in,v 1.3 2005/11/03 07:52:07 fang Exp $
# This file came from "test-expect.sh" in revision prehistory.  

# $1 is the executable, expecting no input
# $2 is the path to the source directory, which is not necessarily ./
#	during distcheck uses _build

cmd=$1
filter=$2/../../../test/address_filter.sed
srcroot=$2/$1
bldroot=$1
morefilter=$srcroot.morefilter.sh

$cmd > $bldroot.out 2>&1
if [ $? -gt 1 ] ; then exit 1 ; fi

$filter $bldroot.out > $bldroot.out.filter

# because some .stderr files are auto-generated, and may be in
# the build directory, not the source directory
if [ -f $srcroot.stderr ]
then
	expect=$srcroot.stderr
else
	if [ -f $1.stderr ]
	then
		expect=$1.stderr
	else
		@ECHO@ "Missing $srcroot.stderr (or $1.stderr)"
		exit 1
	fi
fi

$filter $expect > $bldroot.stderr.filter

# optional filter hook script, to do more than the default filtering
# requirement of morefilter script: should mv .filter files to .prefilter
#	and create replacement .filter files from the .prefilter files
if [ -f $morefilter ]
then
	mv -f $bldroot.stderr.filter $bldroot.stderr.prefilter
	mv -f $bldroot.out.filter $bldroot.out.prefilter
	$morefilter $bldroot.stderr.prefilter $bldroot.stderr.filter
	$morefilter $bldroot.out.prefilter $bldroot.out.filter
	@DIFF@ -u $bldroot.stderr.prefilter $bldroot.out.prefilter 2>&1 | \
		@CAT@ > $bldroot.prefilter.diff
	# what the heck, print a warning message, just FYI
	if [ -s $bldroot.prefilter.diff ]
	then
		@ECHO@ "$bldroot.prefilter.diff is actually non-empty.  (OK)"
	fi
fi

@DIFF@ -u $bldroot.stderr.filter $bldroot.out.filter 2>&1 | \
	@CAT@ > $bldroot.diff

if [ -s $bldroot.diff ]
then
	@ECHO@ "$bldroot.diff is non-empty!"
	exit 1
fi

