#!@SH_PATH@
# "hackt-prsim-expr-alloc-expect.sh.in"
#	$Id: hackt-prsim-expr-alloc-expect.sh.in,v 1.2 2006/01/22 06:53:48 fang Exp $

# $1 is the executable for the creator (hackt alloc), expecting 2 arguments
# $2 is the path to the source directory, which is not necessarily ./
#	during distcheck uses _build
# $3 is the input file name WITHOUT the .in extension
# $4 is the test report log file, summarizing results
# other subsequent arguments are ignored

# if test $# -lt 5 ; then exit 1 ; fi

prsim=$1
srcroot=$2/$3
bldroot=$3
logfile=$4

# a pre-created (already created) object file must already exist
if test ! -s $bldroot.haco-a
then
	@ECHO@ "$bldroot.haco-a doesn't exist or is empty."
	exit 1
fi

# see if it crashes first
$prsim -fno-run -fdump-expr-alloc -fcheck-structure $bldroot.haco-a \
	> $bldroot.prsimexpr 2>&1

# depending on exit status, take action
case $? in
	0) break ;;
	*) exit 1 ;;
esac

if test ! -f $srcroot.expect-prsimexpr && test ! -f $bldroot.expect-prsimexpr
then
	@ECHO@ "Missing $srcroot.expect-prsimexpr"
	exit 1
fi

# some PRS may be empty
if test -s $srcroot.expect-prsimexpr
then
	@DIFF@ -u $srcroot.expect-prsimexpr $bldroot.prsimexpr
else
	@DIFF@ -u $bldroot.expect-prsimexpr $bldroot.prsimexpr
fi > $bldroot.prsimexprdiff

if test -s $bldroot.prsimexprdiff
then
	@ECHO@ "$bldroot.prsimexprdiff is non-empty!  See $logfile."
	@ECHO@ `pwd`/"$bldroot.prsimexprdiff" >> $logfile
	exit 1
fi

