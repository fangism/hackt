# "Make.test-unroll"
#	vi: ft=automake
#	$Id: Make.test-unroll,v 1.8 2007/08/16 20:36:28 fang Exp $
# This is just a portion of the Make.test-tail template included by
# Makefile.am's in the test/ directory subtree.  
# This depends on variables defined in Make.test-tail, and thus, 
# should not be included by itself.  

if USE_UNROLL_PHASE
HACKT_UNROLL_SUFFIXES = .haco-u \
	.unrolldump .unrolldump-filter .unrollstderr \
	.haco-u-dump .haco-u-dump-filter .unrolldiff \
	.unrollfaildump .unrollfaildiff
HACKT_UNROLL_TEST_SUFFIXES = .hacktunrolltest .hacktunrollfailtest
endif
SUFFIXES += $(HACKT_UNROLL_SUFFIXES) $(HACKT_UNROLL_TEST_SUFFIXES)
BOGUS_SUFFIX_TARGETS += $(HACKT_UNROLL_SUFFIXES)

HACKT_UNROLL_CLEAN_IGNORE_PATTERNS = \
	"*.hacktobjtest" \
	"*.hacktunrolltest" \
	"*.hacktunrollfailtest" \
	"*.indump" \
	"*.outdump" \
	"*.objdiff" \
	"*.indump-filter" \
	"*.outdump-filter" \
	"*.compileobjdiff" \
	"*.haco" \
	"*.haco-dump" \
	"*.haco-u" \
	"*.haco-u-dump" \
	"*.haco-u-fail" \
	"*.unrolldiff" \
	"*.unrollfaildiff" \
	"*.unrolldump-noindex" \
	"*.unrolldump-filter-noindex" \
	"*.unrolldiff-noindex" \
	"*.unrollstderr-noindex" \
	"*.unrolldump" \
	"*.unrolldump.filter" \
	"*.unrolldump-filter" \
	"*.unrollfaildump"

AUTO_IGNORE += $(HACKT_UNROLL_CLEAN_IGNORE_PATTERNS)

if USE_UNROLL_PHASE
else
# NOTE: unroll tests have becom obsolete since the fusion of unroll and create
endif

if USE_UNROLL_PHASE
.haco.haco-u:
	$(HACKT_UNROLL_EXE) $< $@
else
# or sym-link
.haco-c.haco-u:
	$(CP) $< $@
endif

.haco-u.haco-u-dump:
	$(DEFAULT_OBJDUMP_RULE_ACTION)

.haco-u.unrolldump:
	$(DEFAULT_OBJDUMP_RULE_ACTION)

.unrolldump.unrolldump-filter:
	@$(CAT) $< | $(HACKT_OBJ_DIFF_FILTER) > $@ ; \
	$(ECHO_FILTERED)

.haco-u-dump.haco-u-dump-filter:
	@$(CAT) $< | $(HACKT_OBJ_DIFF_FILTER) > $@ ; \
	$(ECHO_FILTERED)

if VERBOSE_CHECK
ECHO_UNROLLDUMP_DIFF_COMMAND = $(ECHO) "$(DIFF) -bu $$""(srcdir)/$$stderr $<"
else
ECHO_UNROLLDUMP_DIFF_COMMAND = :
endif

.unrolldump-filter.unrolldiff:
	@stderr=`$(ECHO) $@ | $(SED) 's/\.unrolldiff$$/.unrollstderr/g'` ; \
	expect=$(srcdir)/$$stderr ; \
	$(RM) $@ ; \
	if test -f "$$expect" ; then \
	  $(ECHO_UNROLLDUMP_DIFF_COMMAND) ; \
	  $(DIFF) -bu "$$expect" $< > $@ 2>&1 ; \
	  if test -s $@ ; then \
	    $(ECHO) "$@ is non-empty!" ; \
	    $(ANALYZE_DIFF_AWK) -v quiet=2 $@ > $@-anal ; \
	    if $(GREP) "OK" $@-anal ; then \
	      filtered=`$(ECHO) $@ | $(SED) 's/\.unrolldiff$$/.unrollstderr-noindex/g'` ; \
	      diffout=`$(ECHO) $@ | $(SED) 's/\.unrolldiff$$/.unrolldiff-noindex/g'` ; \
	      $(CAT) "$$expect" | $(POM_INDEX_FILTER) > $$filtered ; \
	      $(CAT) $< | $(POM_INDEX_FILTER) > $<-noindex ; \
	      $(DIFF) -buw "$$filtered" $<-noindex > "$$diffout" 2>&1 ; \
	      $(ANALYZE_DIFF_AWK) -v quiet=0 "$$diffout" ; \
	    fi ; \
	    $(RM) $@-anal ; \
	  fi ; \
	else $(ECHO) "Missing $$expect." | $(TEE) $@ ; \
	fi ; \
	$(TOUCH) $@

.unrolldiff.hacktunrolltest:
	@$(DEFAULT_DIFF_TEST_SCRIPT)

unrolltest.autodepend: Makefile
	@$(ECHO) "Generating dependencies $@" ; \
	$(ECHO) "$(HACKT_UNROLL_TEST_PASSES)" | \
		$(SPACES_TO_NEWLINE) | $(SORT) -u | \
		$(AWK) '/.+/ {print $$1 ".unrolldiff: $$(srcdir)/" $$1 ".unrollstderr"; }' > $@ ; \
	$(TOUCH) $@

if USE_UNROLL_PHASE
-include unrolltest.autodepend
AUTO_DEPENDS += unrolltest.autodepend
endif

.hacktunrolltest:
	@$(DUMMY_TEST_SCRIPT)

if VERBOSE_CHECK
ECHO_UNROLLFAIL_DIFF_COMMAND = $(ECHO) "$(DIFF) -bu $$""(srcdir)/$$stderr $<"
else
ECHO_UNROLLFAIL_DIFF_COMMAND = :
endif

.haco.unrollfaildump:
	-@failobj=`$(ECHO) $@ | $(SED) 's/\.unrollfaildump$$/.haco-u-fail/g'` ; \
	$(ECHO) $(HACKT_UNROLL_EXE) $< "$$failobj" ; \
	$(HACKT_UNROLL_EXE) $< "$$failobj" > $@ 2>&1

.unrollfaildump.unrollfaildiff:
	@stderr=`$(ECHO) $@ | $(SED) 's/\.unrollfaildiff$$/.unrollstderr/g'` ; \
	expect=$(srcdir)/$$stderr ; \
	$(RM) $@ ; \
	if test -f "$$expect" ; then \
	  $(ECHO_UNROLLFAIL_DIFF_COMMAND) ; \
	  $(DIFF) -bu "$$expect" $< > $@ 2>&1 ; \
	  if test -s $@ ; then \
	    $(ECHO) "$@ is non-empty!" ; \
	  fi ; \
	else $(ECHO) "Missing $$expect." | $(TEE) $@ ; \
	fi ; \
	$(TOUCH) $@

.unrollfaildiff.hacktunrollfailtest:
	@$(DEFAULT_DIFF_TEST_SCRIPT)

unrollfailtest.autodepend: Makefile
	@$(ECHO) "Generating dependencies $@" ; \
	$(ECHO) "$(HACKT_UNROLL_TEST_FAILURES)" | \
		$(SPACES_TO_NEWLINE) | $(SORT) -u | \
		$(AWK) '/.+/ {print $$1 ".unrollfaildiff: $$(srcdir)/" $$1 ".unrollstderr"; }' > $@ ; \
	$(TOUCH) $@

if USE_UNROLL_PHASE
-include unrollfailtest.autodepend
AUTO_DEPENDS += unrollfailtest.autodepend
endif

BOGUS_TESTS += .hacktunrolltest .hacktunrollfailtest
BOGUS_TARGETS += .unrollstderr .unrolldump .unrollfaildump \
	.unrolldiff .unrollfaildiff

CHECK_SUMMARIES += unrolldiffs unrollfaildiffs unrolldiffs.noindex

unrolldiffs: force
	-$(CAT) *.unrolldiff > $@

unrollfaildiffs: force
	-$(CAT) *.unrollfaildiff > $@

unrolldiffs.noindex: force
	-$(CAT) *.unrolldiff-noindex > $@


HACKT_UNROLL_TEST_SUBJECTS = \
	$(HACKT_UNROLL_TEST_PASSES) \
	$(HACKT_UNROLL_TEST_FAILURES)

srcdir_EXTRA_DIST += $(HACKT_UNROLL_TEST_SUBJECTS:=.unrollstderr)

UNROLL_BUILD_CHECK_LOCAL =
# unroll tests are now disabled since unroll/create were fused together
if USE_UNROLL_PHASE
if CHECK_TESTS
TESTS += $(HACKT_UNROLL_TEST_PASSES:=.hacktunrolltest) \
	$(HACKT_UNROLL_TEST_FAILURES:=.hacktunrollfailtest)
endif

UNROLL_BUILD_CHECK_LOCAL += \
	$(HACKT_UNROLL_TEST_PASSES:=.haco-u) \
	$(HACKT_UNROLL_TEST_PASSES:=.unrolldump) \
	$(HACKT_UNROLL_TEST_PASSES:=.unrolldump-filter) \
	$(HACKT_UNROLL_TEST_PASSES:=.unrolldiff) \
	$(HACKT_UNROLL_TEST_FAILURES:=.unrollfaildump) \
	$(HACKT_UNROLL_TEST_FAILURES:=.unrollfaildiff)
endif

build-check-local: $(UNROLL_BUILD_CHECK_LOCAL)

echo-unroll-passes: force
	@$(ECHO) $(HACKT_UNROLL_TEST_PASSES)

echo-unroll-failures: force
	@$(ECHO) $(HACKT_UNROLL_TEST_FAILURES)

echo-unroll-tests: force
	@$(ECHO) $(HACKT_UNROLL_TEST_SUBJECTS)

clean-unrolltests:
	patternlist='$(HACKT_UNROLL_CLEAN_IGNORE_PATTERNS)' ; \
	for p in $$patternlist ; do \
	  pp=`$(ECHO) $$p | $(SED) 's/"//g'` ; \
	  $(RM_PATTERN) "$$pp" ; \
	done

clean-local: clean-unrolltests

.PHONY: clean-unrolltests

