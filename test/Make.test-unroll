# "Make.test-unroll"
#	vi: ft=automake
#	$Id: Make.test-unroll,v 1.5.22.1 2007/07/27 19:58:40 fang Exp $
# This is just a portion of the Make.test-tail template included by
# Makefile.am's in the test/ directory subtree.  
# This depends on variables defined in Make.test-tail, and thus, 
# should not be included by itself.  

# obsolete:
# HACKT_UNROLL_TEST_SH = $(TEST_BUILDDIR)/hackt-unroll-expect.sh

if USE_UNROLL_PHASE
else
# NOTE: unroll tests have becom obsolete since the fusion of unroll and create
endif

if USE_UNROLL_PHASE
.haco.haco-u:
	$(HACKT_UNROLL_EXE) $< $@
else
# or sym-link
.haco-c.haco-u:
	$(CP) $< $@
endif

.haco-u.haco-u-dump:
	$(DEFAULT_OBJDUMP_RULE_ACTION)

.haco-u.unrolldump:
	$(DEFAULT_OBJDUMP_RULE_ACTION)

.unrolldump.unrolldump-filter:
	@$(CAT) $< | $(HACKT_OBJ_DIFF_FILTER) > $@ ; \
	$(ECHO_FILTERED)

.haco-u-dump.haco-u-dump-filter:
	@$(CAT) $< | $(HACKT_OBJ_DIFF_FILTER) > $@ ; \
	$(ECHO_FILTERED)

if VERBOSE_CHECK
ECHO_UNROLLDUMP_DIFF_COMMAND = $(ECHO) "$(DIFF) -bu $$""(srcdir)/$$stderr $<"
else
ECHO_UNROLLDUMP_DIFF_COMMAND = :
endif

.unrolldump-filter.unrolldiff:
	@stderr=`$(ECHO) $@ | $(SED) 's/\.unrolldiff$$/.unrollstderr/g'` ; \
	expect=$(srcdir)/$$stderr ; \
	$(RM) $@ ; \
	if test -f "$$expect" ; then \
	  $(ECHO_UNROLLDUMP_DIFF_COMMAND) ; \
	  $(DIFF) -bu "$$expect" $< > $@ 2>&1 ; \
	  if test -s $@ ; then \
	    $(ECHO) "$@ is non-empty!" ; \
	    $(ANALYZE_DIFF_AWK) -v quiet=2 $@ > $@-anal ; \
	    if $(GREP) "OK" $@-anal ; then \
	      filtered=`$(ECHO) $@ | $(SED) 's/\.unrolldiff$$/.unrollstderr-noindex/g'` ; \
	      diffout=`$(ECHO) $@ | $(SED) 's/\.unrolldiff$$/.unrolldiff-noindex/g'` ; \
	      $(CAT) "$$expect" | $(POM_INDEX_FILTER) > $$filtered ; \
	      $(CAT) $< | $(POM_INDEX_FILTER) > $<-noindex ; \
	      $(DIFF) -buw "$$filtered" $<-noindex > "$$diffout" 2>&1 ; \
	      $(ANALYZE_DIFF_AWK) -v quiet=0 "$$diffout" ; \
	    fi ; \
	    $(RM) $@-anal ; \
	  fi ; \
	else $(ECHO) "Missing $$expect." | $(TEE) $@ ; \
	fi ; \
	$(TOUCH) $@

.unrolldiff.hacktunrolltest:
	@$(DEFAULT_DIFF_TEST_SCRIPT)

unrolltest.autodepend: Makefile
	@$(ECHO) "Generating dependencies $@" ; \
	$(ECHO) "$(HACKT_UNROLL_TEST_PASSES)" | \
		$(SPACES_TO_NEWLINE) | $(SORT) -u | \
		$(AWK) '/.+/ {print $$1 ".unrolldiff: $$(srcdir)/" $$1 ".unrollstderr"; }' > $@ ; \
	$(TOUCH) $@

if USE_UNROLL_PHASE
-include unrolltest.autodepend
AUTO_DEPENDS += unrolltest.autodepend
endif

.hacktunrolltest:
	@$(DUMMY_TEST_SCRIPT)

if VERBOSE_CHECK
ECHO_UNROLLFAIL_DIFF_COMMAND = $(ECHO) "$(DIFF) -bu $$""(srcdir)/$$stderr $<"
else
ECHO_UNROLLFAIL_DIFF_COMMAND = :
endif

.haco.unrollfaildump:
	-@failobj=`$(ECHO) $@ | $(SED) 's/\.unrollfaildump$$/.haco-u-fail/g'` ; \
	$(ECHO) $(HACKT_UNROLL_EXE) $< "$$failobj" ; \
	$(HACKT_UNROLL_EXE) $< "$$failobj" > $@ 2>&1

.unrollfaildump.unrollfaildiff:
	@stderr=`$(ECHO) $@ | $(SED) 's/\.unrollfaildiff$$/.unrollstderr/g'` ; \
	expect=$(srcdir)/$$stderr ; \
	$(RM) $@ ; \
	if test -f "$$expect" ; then \
	  $(ECHO_UNROLLFAIL_DIFF_COMMAND) ; \
	  $(DIFF) -bu "$$expect" $< > $@ 2>&1 ; \
	  if test -s $@ ; then \
	    $(ECHO) "$@ is non-empty!" ; \
	  fi ; \
	else $(ECHO) "Missing $$expect." | $(TEE) $@ ; \
	fi ; \
	$(TOUCH) $@

.unrollfaildiff.hacktunrollfailtest:
	@$(DEFAULT_DIFF_TEST_SCRIPT)

unrollfailtest.autodepend: Makefile
	@$(ECHO) "Generating dependencies $@" ; \
	$(ECHO) "$(HACKT_UNROLL_TEST_FAILURES)" | \
		$(SPACES_TO_NEWLINE) | $(SORT) -u | \
		$(AWK) '/.+/ {print $$1 ".unrollfaildiff: $$(srcdir)/" $$1 ".unrollstderr"; }' > $@ ; \
	$(TOUCH) $@

if USE_UNROLL_PHASE
-include unrollfailtest.autodepend
AUTO_DEPENDS += unrollfailtest.autodepend
endif

BOGUS_TESTS += .hacktunrolltest .hacktunrollfailtest
BOGUS_TARGETS += .unrollstderr .unrolldump .unrollfaildump \
	.unrolldiff .unrollfaildiff

CHECK_SUMMARIES += unrolldiffs unrollfaildiffs unrolldiffs.noindex

unrolldiffs: force
	-$(CAT) *.unrolldiff > $@

unrollfaildiffs: force
	-$(CAT) *.unrollfaildiff > $@

unrolldiffs.noindex: force
	-$(CAT) *.unrolldiff-noindex > $@


HACKT_UNROLL_TEST_SUBJECTS = \
	$(HACKT_UNROLL_TEST_PASSES) \
	$(HACKT_UNROLL_TEST_FAILURES)

srcdir_EXTRA_DIST += $(HACKT_UNROLL_TEST_SUBJECTS:=.unrollstderr)

UNROLL_BUILD_CHECK_LOCAL =
# unroll tests are now disabled since unroll/create were fused together
if USE_UNROLL_PHASE
if CHECK_TESTS
TESTS += $(HACKT_UNROLL_TEST_PASSES:=.hacktunrolltest) \
	$(HACKT_UNROLL_TEST_FAILURES:=.hacktunrollfailtest)
endif

UNROLL_BUILD_CHECK_LOCAL += \
	$(HACKT_UNROLL_TEST_PASSES:=.haco-u) \
	$(HACKT_UNROLL_TEST_PASSES:=.unrolldump) \
	$(HACKT_UNROLL_TEST_PASSES:=.unrolldump-filter) \
	$(HACKT_UNROLL_TEST_PASSES:=.unrolldiff) \
	$(HACKT_UNROLL_TEST_FAILURES:=.unrollfaildump) \
	$(HACKT_UNROLL_TEST_FAILURES:=.unrollfaildiff)
endif

build-check-local: $(UNROLL_BUILD_CHECK_LOCAL)

echo-unroll-passes: force
	@$(ECHO) $(HACKT_UNROLL_TEST_PASSES)

echo-unroll-failures: force
	@$(ECHO) $(HACKT_UNROLL_TEST_FAILURES)

echo-unroll-tests: force
	@$(ECHO) $(HACKT_UNROLL_TEST_SUBJECTS)

clean-unrolltests:
	-$(RM_PATTERN) "*.hacktobjtest"
	-$(RM_PATTERN) "*.hacktunrolltest"
	-$(RM_PATTERN) "*.hacktunrollfailtest"
	-$(RM_PATTERN) "*.indump"
	-$(RM_PATTERN) "*.outdump"
	-$(RM_PATTERN) "*.objdiff"
	-$(RM_PATTERN) "*.indump-filter"
	-$(RM_PATTERN) "*.outdump-filter"
	-$(RM_PATTERN) "*.compileobjdiff"
	-$(RM_PATTERN) "*.haco"
	-$(RM_PATTERN) "*.haco-dump"
	-$(RM_PATTERN) "*.haco-u"
	-$(RM_PATTERN) "*.haco-u-dump"
	-$(RM_PATTERN) "*.haco-u-fail"
	-$(RM_PATTERN) "*.unrolldiff"
	-$(RM_PATTERN) "*.unrollfaildiff"
	-$(RM_PATTERN) "*.unrolldump-noindex"
	-$(RM_PATTERN) "*.unrolldump-filter-noindex"
	-$(RM_PATTERN) "*.unrolldiff-noindex"
	-$(RM_PATTERN) "*.unrollstderr-noindex"
	-$(RM_PATTERN) "*.unrolldump"
	-$(RM_PATTERN) "*.unrolldump.filter"
	-$(RM_PATTERN) "*.unrolldump-filter"
	-$(RM_PATTERN) "*.unrollfaildump"

clean-local: clean-unrolltests

.PHONY: clean-unrolltests

