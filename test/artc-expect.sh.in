#!@SH_PATH@
# "artc-expect.sh.in"
#	$Id: artc-expect.sh.in,v 1.7 2005/12/08 22:01:14 fang Exp $
# This file came from "artc-expect.sh" in revision pre-history.

# $1 is the executable, expecting input from stdin ("hackt parse_test")
# $2 is the path to the source directory, which is not necessarily ./
#	during distcheck uses _build
# $3 is the input file name WITHOUT the .in extension
# $4 is the filter for ignoring certain difference in output
#	(for no filter, pass "cat")
# $5 is the test report log file, summarizing results
# other subsequent arguments are ignored

# if test $# -lt 6 ; then exit 1 ; fi

# need to search source directory for VPATH builds
cmd="$1 -I $2"
srcroot=$2/$3
bldroot=$3
filter="$4"
logfile=$5

# echo $cmd
# echo $srcroot
# echo $bldroot
# echo $filter
# echo $logfile

# intentionally using stdin to avoid file name differences in output diff-ing
$cmd < $srcroot.in > $bldroot.test 2>&1
if test $? -gt 1 ; then exit 1 ; fi
@CAT@ $bldroot.test | $filter > $bldroot.test.filter
if test -f $srcroot.stderr ; then
	@DIFF@ -bu $srcroot.stderr $bldroot.test.filter > $bldroot.diff 2>&1
elif test -f $bldroot.stderr ; then
	# this would've been created by the Makefile automatically
	@DIFF@ -bu $bldroot.stderr $bldroot.test.filter > $bldroot.diff 2>&1
else
	@ECHO@ "Missing $srcroot.stderr." > $bldroot.diff
fi


# first-try: if different, see if it's because of bison...
# if so, re-run using bison's expected output
# otherwise, exit with error
# there will never be $bldroot.stderr.bison 
# (meaning: empty, and generated by Makefile)

# NOTE: so far, byacc results in the same state machine as yacc
# thus the yacc tests are re-usable for byacc, we only need to check for bison.

@HAVE_BISON_TRUE@if test -s $bldroot.diff ; then
@HAVE_BISON_TRUE@	if test -f $srcroot.stderr.bison ; then
@HAVE_BISON_TRUE@	@DIFF@ -bu $srcroot.stderr.bison $bldroot.test.filter \
@HAVE_BISON_TRUE@		> $bldroot.bison.diff 2>&1
@HAVE_BISON_TRUE@		if test ! -s $bldroot.bison.diff ; then
@HAVE_BISON_TRUE@			mv -f $bldroot.bison.diff $bldroot.diff
@HAVE_BISON_TRUE@		else
@HAVE_BISON_TRUE@			@ECHO@ "$bldroot.bison.diff is non-empty!"
@HAVE_BISON_TRUE@		fi
@HAVE_BISON_TRUE@	else
@HAVE_BISON_TRUE@		@ECHO@ "Missing $srcroot.stderr.bison."
@HAVE_BISON_TRUE@		exit 1;
@HAVE_BISON_TRUE@	fi
@HAVE_BISON_TRUE@fi

if test -s $bldroot.diff ; then
	@ECHO@ "$bldroot.diff is non-empty!  See $logfile."
	@ECHO@ `pwd`/"$bldroot.diff" >> $logfile
	exit 1
fi

