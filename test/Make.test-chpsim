# "Make.test-chpsim"
#	vi: ft=automake
#	$Id: Make.test-chpsim,v 1.7 2007/06/12 05:13:21 fang Exp $
# This is just a portion of the Make.test-tail template included by
# Makefile.am's in the test/ directory subtree.  
# This depends on variables defined in Make.test-tail, and thus, 
# should not be included by itself.  

CHPSIM_ALLOC_DUMP = $(HACKT_CHPSIM_EXE) -fno-run -fdump-graph-alloc
CHPSIM_GRAPH_DOT = $(HACKT_CHPSIM_EXE) -fno-run -fdump-dot-struct -fcluster-processes -fshow-channels

CHPSIMCKPT_TEMPLATE_SCRIPT = $(TEST_SRCDIR)/chpsimckpt-template.chpsimrc
CHPSIMCKPT_LOAD_TEMPLATE_SCRIPT = $(TEST_SRCDIR)/chpsimckpt-load-template.chpsimrc

.haco-a.chpsimallocdump:
	$(CHPSIM_ALLOC_DUMP) $< > $@

.haco-a.chpsim-event-dot:
	@$(ECHO) "$(CHPSIM_GRAPH_DOT) $< > $@" ; \
	if $(CHPSIM_GRAPH_DOT) $< > $@.tmp ; then $(MV) $@.tmp $@ ; \
	else $(RM) $@.tmp ; exit 1 ; \
	fi

.chpsim-event-dot.chpsim-event-ps:
if HAVE_DOT
	$(DOT) -Tps $< -o $@
else
	@$(ECHO) "No dot found in path during configure."
endif


if VERBOSE_CHECK
ECHO_CHPSIM_ALLOC_DIFF_COMMAND = $(ECHO) "$(DIFF) -bu $$""(srcdir)/$$stderr $<"
else
ECHO_CHPSIM_ALLOC_DIFF_COMMAND = :
endif

.chpsimallocdump.chpsimallocdiff:
	@stderr=`$(ECHO) $@ | $(SED) 's/\.chpsimallocdiff$$/.expect-chpsimalloc/g'` ; \
	expect=$(srcdir)/$$stderr ; \
	$(RM) $@ ; \
	if test -f "$$expect" ; then \
	  $(ECHO_CHPSIM_ALLOC_DIFF_COMMAND) ; \
	  $(DIFF) -bu "$$expect" $< > $@ 2>&1 ; \
	  if test -s $@ ; then \
	    $(ECHO) "$@ is non-empty!" ; \
	  fi ; \
	else $(ECHO) "Missing $$expect." | $(TEE) $@ ; \
	fi ; \
	$(TOUCH) $@

.chpsimallocdiff.chpsimalloctest:
	@$(DEFAULT_DIFF_TEST_SCRIPT)

.chpsimalloctest:
	@$(DUMMY_TEST_SCRIPT)

chpsimalloctest.autodepend: Makefile
	@$(ECHO) "Generating dependencies $@" ; \
	$(ECHO) "$(HACKT_CHPSIM_ALLOC_TEST_SUBJECTS)" | \
	  $(SPACES_TO_NEWLINE) | $(SORT) -u | \
	  $(AWK) '/.+/ {print $$1 ".chpsimallocdiff: $$(srcdir)/" $$1 ".expect-chpsimalloc"; }' > $@ ; \
	$(TOUCH) $@

-include chpsimalloctest.autodepend
AUTO_DEPENDS += chpsimalloctest.autodepend

# chpsim event graph tests
.chpsim-event-dot.chpsimdottest:
	@$(DUMMY_TEST_SCRIPT)

.chpsimdottest:
	@$(DUMMY_TEST_SCRIPT)

# no additional dependencies for chpsimdottest needed

# TODO: support checkpointing in test cases that pass
# NOTE: EXTRACT_HACO_PIPE is defined in "Make.test-prsim"
# TODO: extract additional command-line flags from the source script
#	maybe using @chpsim-flags@ as a match pattern
CHPSIMRC_TEST_SCRIPT = \
	obj=`$(CAT) $< | $(EXTRACT_HACO_PIPE)` ; \
	ckpt=`$(ECHO) $@ | $(SED) 's/\.chpsim.*$$/.chpsimckpt/g'` ; \
	$(ECHO) "ckpt: $(HACKT_CHPSIM_EXE) -b -I$(srcdir) $$obj < $<" ; \
	$(CAT) $(CHPSIMCKPT_TEMPLATE_SCRIPT) | \
	  $(SED) -e 's|SOURCE|$<|g' -e 's|CHECKPOINT|'"$$ckpt"'|g' | \
	  $(HACKT_CHPSIM_EXE) -b -I$(srcdir) "$$obj" > $@ 2>&1 ; \
	$(TOUCH) $@

# the same until we add checkpointing to the pass test
CHPSIMRC_FAIL_TEST_SCRIPT = \
	obj=`$(CAT) $< | $(EXTRACT_HACO_PIPE)` ; \
	$(ECHO) "$(HACKT_CHPSIM_EXE) -b -I$(srcdir) $$obj < $<" ; \
	$(HACKT_CHPSIM_EXE) -b -I$(srcdir) "$$obj" < $< > $@ 2>&1

.chpsimrc.chpsimrc-out:
	@$(CHPSIMRC_TEST_SCRIPT)

.chpsimrc.chpsimrcfail-out:
	-@$(CHPSIMRC_FAIL_TEST_SCRIPT)

if VERBOSE_CHECK
ECHO_CHPSIMRC_DIFF_COMMAND = $(ECHO) "$(DIFF) -bu $$expect $<"
else
ECHO_CHPSIMRC_DIFF_COMMAND = :
endif

CHPSIMRC_TEST_FILTER_SCRIPT = \
	$(SED) -e '/DELETE FROM HERE/d' -e '/DELETE TO HERE/,$$d' $< > $@

.chpsimrc-out.chpsimrc-out-filter:
	@$(CHPSIMRC_TEST_FILTER_SCRIPT)

# TODO: introduce filtering scripts and differences
.chpsimrc-out-filter.chpsimrc-diff:
	@stderr=`$(ECHO) $@ |$(SED) 's/\.chpsimrc-diff$$/.chpsimrc-expect/g'`; \
	expect="$(srcdir)/$$stderr" ; \
	$(RM) $@ ; \
	if test -f "$$expect" ; then \
	  $(ECHO_CHPSIMRC_DIFF_COMMAND) ; \
	  $(DIFF) -bu "$$expect" $< > $@ 2>&1 ; \
	  if test -s $@ ; then \
	    $(ECHO) "$@ is non-empty!" ; \
	  fi ; \
	else $(ECHO) "Missing $$expect." | $(TEE) $@ ; \
	fi ; \
	$(TOUCH) $@

.chpsimrcfail-out.chpsimrcfail-diff:
	@stderr=`$(ECHO) $@ |$(SED) 's/\.chpsimrcfail-diff$$/.chpsimrc-expect/g'`; \
	expect="$(srcdir)/$$stderr" ; \
	$(RM) $@ ; \
	if test -f "$$expect" ; then \
	  $(ECHO_CHPSIMRC_DIFF_COMMAND) ; \
	  $(DIFF) -bu "$$expect" $< > $@ 2>&1 ; \
	  if test -s $@ ; then \
	    $(ECHO) "$@ is non-empty!" ; \
	  fi ; \
	else $(ECHO) "Missing $$expect." | $(TEE) $@ ; \
	fi ; \
	$(TOUCH) $@

# TODO: write rules for fail-tests

.chpsimrc-diff.chpsimtest:
	@$(DEFAULT_DIFF_TEST_SCRIPT)

.chpsimrcfail-diff.chpsimfailtest:
	@$(DEFAULT_DIFF_TEST_SCRIPT)

.chpsimtest:
	@$(DUMMY_TEST_SCRIPT)

.chpsimfailtest:
	@$(DUMMY_TEST_SCRIPT)

chpsimrc-out.autodepend: Makefile
	@$(ECHO) "Generating dependencies $@" ; \
	$(ECHO) -n "" > $@ ; \
	list='$(HACKT_CHPSIMRC_TEST_SCRIPTS_PASSES)' ; \
	exts='chpsimrc-out' ; \
	test -z "$$list" || \
	for d in $$list ; do \
	  src=$(srcdir)/$$d.chpsimrc ; \
	  obj=`$(CAT) "$$src" | $(EXTRACT_HACO_PIPE)` ; \
	  for e in $$exts ; do \
	    target=$$d.$$e ; \
	    $(ECHO) -n "$$target " ; \
	  done ; \
	  $(ECHO) ": $$obj" ; \
	done > $@ ; \
	$(TOUCH) $@

-include chpsimrc-out.autodepend
AUTO_DEPENDS += chpsimrc-out.autodepend

chpsimrcfail-out.autodepend: Makefile
	@$(ECHO) "Generating dependencies $@" ; \
	$(ECHO) -n "" > $@ ; \
	list='$(HACKT_CHPSIMRC_TEST_SCRIPTS_FAILURES)' ; \
	exts='chpsimrcfail-out' ; \
	test -z "$$list" || \
	for d in $$list ; do \
	  src=$(srcdir)/$$d.chpsimrc ; \
	  obj=`$(CAT) "$$src" | $(EXTRACT_HACO_PIPE)` ; \
	  for e in $$exts ; do \
	    target=$$d.$$e ; \
	    $(ECHO) -n "$$target " ; \
	  done ; \
	  $(ECHO) ": $$obj" ; \
	done > $@ ; \
	$(TOUCH) $@

-include chpsimrcfail-out.autodepend
AUTO_DEPENDS += chpsimrcfail-out.autodepend

chpsimrctest.autodepend: Makefile
	@$(ECHO) "Generating dependencies $@" ; \
	$(ECHO) "$(HACKT_CHPSIMRC_TEST_SCRIPTS_PASSES)" | \
	  $(SPACES_TO_NEWLINE) | $(SORT) -u | \
	  $(AWK) '/.+/ {print $$1 ".chpsimrc-diff: $$(srcdir)/" $$1 ".chpsimrc-expect"; }' > $@ ; \
	$(TOUCH) $@

-include chpsimrctest.autodepend
AUTO_DEPENDS += chpsimrctest.autodepend


chpsimrcfailtest.autodepend: Makefile
	@$(ECHO) "Generating dependencies $@" ; \
	$(ECHO) "$(HACKT_CHPSIMRC_TEST_SCRIPTS_FAILURES)" | \
	  $(SPACES_TO_NEWLINE) | $(SORT) -u | \
	  $(AWK) '/.+/ {print $$1 ".chpsimrcfail-diff: $$(srcdir)/" $$1 ".chpsimrc-expect"; }' > $@ ; \
	$(TOUCH) $@

-include chpsimrcfailtest.autodepend
AUTO_DEPENDS += chpsimrcfailtest.autodepend

# checkpoint is simultaneously generated
.chpsimrc-out.chpsimckpt:
	@$(NO_OP_SCRIPT)

.chpsimrc-out.chpsimckpt-outdump:
	@$(SED) '/DELETE FROM HERE/,/DELETE TO HERE/d' $< > $@

.chpsimckpt.chpsimckpt-indump:
	@rc=$(srcdir)/`$(ECHO) $< | $(SED) 's/\.chpsimckpt$$/.chpsimrc/g'` ; \
	obj=`$(CAT) "$$rc" | $(EXTRACT_HACO_PIPE)` ; \
	ckpt=`$(ECHO) $@ | $(SED) 's/-indump$$/-dupe/g'` ; \
	$(ECHO) "load: $(HACKT_CHPSIM_EXE) -b -I$(srcdir) $$obj" ; \
	$(CAT) $(CHPSIMCKPT_LOAD_TEMPLATE_SCRIPT) | \
	  $(SED) -e 's|LOAD|$<|g' -e 's|SAVE|'"$$ckpt"'|g' | \
	  $(HACKT_CHPSIM_EXE) -b -I$(srcdir) "$$obj" > $@ 2>&1

# simultaneously generated
.chpsimckpt-indump.chpsimckpt-dupe:
	@$(NO_OP_SCRIPT)

# this one needs the object file attached
.chpsimckpt-dupe.chpsimckpt-dupe-dump:
	@rc=$(srcdir)/`$(ECHO) $< | $(SED) 's/\.chpsimckpt-dupe$$/.chpsimrc/g'` ; \
	obj=`$(CAT) "$$rc" | $(EXTRACT_HACO_PIPE)` ; \
	{ $(ECHO) "load $<" ; $(ECHO) "dump-state" ;} | \
	  $(HACKT_CHPSIM_EXE) -b $< > $@


if VERBOSE_CHECK
ECHO_CHPSIMCKPT_DIFF_COMMAND = $(ECHO) "$(DIFF) -u $$expect $<"
else
ECHO_CHPSIMCKPT_DIFF_COMMAND = :
endif

.chpsimckpt-outdump.chpsimckpt-diff:
	@expect=`$(ECHO) $@ | $(SED) 's/\.chpsimckpt-diff$$/.chpsimckpt-indump/g'` ; \
	$(RM) $@ ; \
	if test -f "$$expect" ; then \
	  $(ECHO_CHPSIMCKPT_DIFF_COMMAND) ; \
	  $(DIFF) -u "$$expect" $< > $@ 2>&1 ; \
	  ca=`$(ECHO) $@ | $(SED) 's/-diff$$//g'` ; \
	  cb=`$(ECHO) $@ | $(SED) 's/-diff$$/-dupe/g'` ; \
	  if test -s $@ ; then \
	    $(ECHO) "$@ is non-empty!" ; \
	  elif $(DIFF) -q "$$ca" "$$cb" ; then : ; \
	  else $(MAKE) "$$ca"-dump "$$cb"-dump && \
	    $(DIFF) -u "$$ca"-dump "$$cb"-dump > $@ ; \
	    $(ECHO) "$@ is non-empty! (checkpoint binaries differ)" ; \
	  fi ; \
	else $(ECHO) "Missing $$expect." | $(TEE) $@ ; \
	fi ; \
	$(TOUCH) $@

.chpsimckpt-diff.chpsimckpttest:
	@$(DEFAULT_DIFF_TEST_SCRIPT)

.chpsimckpttest:
	@$(DUMMY_TEST_SCRIPT)

chpsimckpttest.autodepend: Makefile
	@$(ECHO) "Generating dependencies $@" ; \
	$(ECHO) "$(HACKT_CHPSIM_CKPT_TEST_SCRIPTS_BASES)" | \
	  $(SPACES_TO_NEWLINE) | $(SORT) -u | \
	  $(AWK) '/.+/ {print $$1 ".chpsimckpt-diff: " $$1 ".chpsimckpt-indump"; }' > $@ ; \
	$(TOUCH) $@

-include chpsimckpttest.autodepend
AUTO_DEPENDS += chpsimckpttest.autodepend

BOGUS_TESTS += .chpsimalloctest .chpsimtest .chpsimdottest \
	.chpsimfailtest .chpsimckpttest

CHECK_SUMMARIES += chpsimallocdiffs chpsimrcdiffs chpsimrcfaildiffs \
	chpsimckptdiffs

chpsimallocdiffs: force
	-$(CAT) *.chpsimallocdiff > $@

chpsimrcdiffs: force
	-$(CAT) *.chpsimrc-diff > $@

chpsimrcfaildiffs: force
	-$(CAT) *.chpsimrcfail-diff > $@

chpsimckptdiffs: force
	-$(CAT) *.chpsimckpt-diff > $@

HACKT_CHPSIMRC_TEST_SCRIPTS_BASES = \
	$(HACKT_CHPSIMRC_TEST_SCRIPTS_PASSES) \
	$(HACKT_CHPSIMRC_TEST_SCRIPTS_FAILURES)

srcdir_EXTRA_DIST += \
	$(HACKT_CHPSIM_ALLOC_TEST_SUBJECTS:=.expect-chpsimalloc) \
	$(HACKT_CHPSIMRC_TEST_SUBJECTS:=.hac) \
	$(HACKT_CHPSIMRC_TEST_SCRIPTS_BASES:=.chpsimrc) \
	$(HACKT_CHPSIMRC_TEST_SCRIPTS_BASES:=.chpsimrc-expect)

# all alloc tests and prsimrc tests are candidates for prs-dot tests
HACKT_CHPSIM_DOT_TEST_SUBJECTS =
HACKT_CHPSIM_DOT_TEST_SUBJECTS += $(HACKT_CREATE_TEST_PASSES)
# updated to ALLOC_TEST_PASSES now?
# HACKT_CHPSIM_DOT_TEST_SUBJECTS += $(HACKT_CHPSIMRC_TEST_PASSES)

TESTS += \
	$(HACKT_CHPSIM_ALLOC_TEST_SUBJECTS:=.chpsimalloctest) \
	$(HACKT_CHPSIM_DOT_TEST_SUBJECTS:=.chpsimdottest) \
	$(HACKT_CHPSIMRC_TEST_SCRIPTS_PASSES:=.chpsimtest) \
	$(HACKT_CHPSIMRC_TEST_SCRIPTS_FAILURES:=.chpsimfailtest) \
	$(HACKT_CHPSIM_CKPT_TEST_SCRIPTS_BASES:=.chpsimckpttest)

HAC_COMPILE_OBJECT_TARGETS += \
	$(HACKT_CHPSIMRC_TEST_SUBJECTS:=.haco)

HAC_CREATE_OBJECT_TARGETS += \
	$(HACKT_CHPSIMRC_TEST_SUBJECTS:=.haco-c) \
	$(HACKT_CHPSIM_ALLOC_TEST_SUBJECTS:=.haco-c)

HAC_ALLOC_OBJECT_TARGETS += \
	$(HACKT_CHPSIMRC_TEST_SUBJECTS:=.haco-a) \
	$(HACKT_CHPSIM_ALLOC_TEST_SUBJECTS:=.haco-a)

build-check-local: \
	$(HACKT_CHPSIM_ALLOC_TEST_SUBJECTS:=.haco-a) \
	$(HACKT_CHPSIM_ALLOC_TEST_SUBJECTS:=.chpsimallocdump) \
	$(HACKT_CHPSIM_DOT_TEST_SUBJECTS:=.chpsim-event-dot) \
	$(HACKT_CHPSIM_DOT_TEST_SUBJECTS:=.chpsimdottest) \
	$(HACKT_CHPSIMRC_TEST_SUBJECTS:=.haco-a) \
	$(HACKT_CHPSIMRC_TEST_SCRIPTS_PASSES:=.chpsimrc-out) \
	$(HACKT_CHPSIMRC_TEST_SCRIPTS_PASSES:=.chpsimrc-out-filter) \
	$(HACKT_CHPSIMRC_TEST_SCRIPTS_PASSES:=.chpsimrc-diff) \
	$(HACKT_CHPSIMRC_TEST_SCRIPTS_FAILURES:=.chpsimrcfail-out) \
	$(HACKT_CHPSIMRC_TEST_SCRIPTS_FAILURES:=.chpsimrcfail-diff) \
	$(HACKT_CHPSIM_CKPT_TEST_SCRIPTS_BASES:=.chpsimckpt) \
	$(HACKT_CHPSIM_CKPT_TEST_SCRIPTS_BASES:=.chpsimckpt-outdump) \
	$(HACKT_CHPSIM_CKPT_TEST_SCRIPTS_BASES:=.chpsimckpt-dupe) \
	$(HACKT_CHPSIM_CKPT_TEST_SCRIPTS_BASES:=.chpsimckpt-indump) \
	$(HACKT_CHPSIM_CKPT_TEST_SCRIPTS_BASES:=.chpsimckpt-diff)

ALL_CHPSIM_DOT = $(HACKT_CHPSIM_DOT_TEST_SUBJECTS:=.chpsim-event-dot)
ALL_CHPSIM_PS = $(HACKT_CHPSIM_DOT_TEST_SUBJECTS:=.chpsim-event-ps)
ALL_CHPSIMRC_OUT = $(HACKT_CHPSIMRC_TEST_SCRIPTS_PASSES:=.chpsimrc-out) \
	$(HACKT_CHPSIMRC_TEST_SCRIPTS_FAILURES:=.chpsimrcfail-out)
ALL_CHPSIM_CKPT = $(HACKT_CHPSIM_CKPT_TEST_SCRIPTS_BASES:=.chpsimckpt)

$(ALL_CHPSIM_DOT): $(HACKT_CHPSIM_EXE)
$(ALL_CHPSIMRC_OUT): $(HACKT_CHPSIM_EXE)
$(ALL_CHPSIM_CKPT): $(HACKT_CHPSIM_EXE)

all-chpsim-dot: $(ALL_CHPSIM_DOT)

all-chpsim-ps: $(ALL_CHPSIM_PS)

clean-chpsim-dot: force
	-$(RM) $(ALL_CHPSIM_DOT)

clean-chpsim-ps: force
	-$(RM) $(ALL_CHPSIM_PS)

echo-chpsimalloc-tests: force
	@$(ECHO) $(HACKT_CHPSIM_ALLOC_TEST_SUBJECTS)

echo-chpsimdot-tests: force
	@$(ECHO) $(HACKT_CHPSIM_DOT_TEST_SUBJECTS)

echo-chpsimrc-passes: force
	@$(ECHO) $(HACKT_CHPSIMRC_TEST_SCRIPTS_PASSES)

echo-chpsimrc-failures: force
	@$(ECHO) $(HACKT_CHPSIMRC_TEST_SCRIPTS_FAILURES)

echo-chpsimckpt-tests: force
	@$(ECHO) $(HACKT_CHPSIM_CKPT_TEST_SCRIPTS_BASES)

clean-chpsimtests:
	-$(RM_PATTERN) "*.chpsimallocdump"
	-$(RM_PATTERN) "*.chpsimallocdiff"
	-$(RM_PATTERN) "*.chpsimalloctest"
	-$(RM_PATTERN) "*.chpsim-event-dot"
	-$(RM_PATTERN) "*.chpsim-event-ps"
	-$(RM_PATTERN) "*.chpsimdottest"
	-$(RM_PATTERN) "*.chpsimrc-out"
	-$(RM_PATTERN) "*.chpsimrc-out-filter"
	-$(RM_PATTERN) "*.chpsimrc-diff"
	-$(RM_PATTERN) "*.chpsimtest"
	-$(RM_PATTERN) "*.chpsimrcfail-out"
	-$(RM_PATTERN) "*.chpsimrcfail-diff"
	-$(RM_PATTERN) "*.chpsimfailtest"
	-$(RM_PATTERN) "*.chpsimckpt"
	-$(RM_PATTERN) "*.chpsimckpt-outdump"
	-$(RM_PATTERN) "*.chpsimckpt-dupe"
	-$(RM_PATTERN) "*.chpsimckpt-dupe-dump"
	-$(RM_PATTERN) "*.chpsimckpt-indump"
	-$(RM_PATTERN) "*.chpsimckpt-diff"
	-$(RM_PATTERN) "*.chpsimckpttest"
	-$(RM_PATTERN) "*.chpsimtrace"

clean-local: clean-chpsimtests

.PHONY: clean-chpsimtests all-chpsim-dot all-chpsim-ps

