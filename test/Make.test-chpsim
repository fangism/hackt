# "Make.test-chpsim"
#	vi: ft=automake
#	$Id: Make.test-chpsim,v 1.2.2.1 2007/01/27 06:33:36 fang Exp $
# This is just a portion of the Make.test-tail template included by
# Makefile.am's in the test/ directory subtree.  
# This depends on variables defined in Make.test-tail, and thus, 
# should not be included by itself.  

CHPSIM_ALLOC_DUMP = $(HACKT_CHPSIM_EXE) -fno-run -fdump-graph-alloc
CHPSIM_GRAPH_DOT = $(HACKT_CHPSIM_EXE) -fno-run -fdump-dot-struct

.haco-a.chpsimallocdump:
	$(CHPSIM_ALLOC_DUMP) $< > $@

.haco-a.chpsim-event-dot:
	@$(ECHO) "$(CHPSIM_GRAPH_DOT) $< > $@" ; \
	if $(CHPSIM_GRAPH_DOT) $< > $@.tmp ; then $(MV) $@.tmp $@ ; \
	else $(RM) $@.tmp ; exit 1 ; \
	fi

.chpsim-event-dot.chpsim-event-ps:
if HAVE_DOT
	$(DOT) -Tps $< -o $@
else
	@$(ECHO) "No dot found in path during configure."
endif


if VERBOSE_CHECK
ECHO_CHPSIM_ALLOC_DIFF_COMMAND = $(ECHO) "$(DIFF) -bu $$""(srcdir)/$$stderr $<"
else
ECHO_CHPSIM_ALLOC_DIFF_COMMAND = :
endif

.chpsimallocdump.chpsimallocdiff:
	@stderr=`$(ECHO) $@ | $(SED) 's/\.chpsimallocdiff$$/.expect-chpsimalloc/g'` ; \
	expect=$(srcdir)/$$stderr ; \
	$(RM) $@ ; \
	if test -f "$$expect" ; then \
	  $(ECHO_CHPSIM_ALLOC_DIFF_COMMAND) ; \
	  $(DIFF) -bu "$$expect" $< > $@ 2>&1 ; \
	  if test -s $@ ; then \
	    $(ECHO) "$@ is non-empty!" ; \
	  fi ; \
	else $(ECHO) "Missing $$expect." | $(TEE) $@ ; \
	fi ; \
	$(TOUCH) $@

.chpsimallocdiff.chpsimalloctest:
	@$(DEFAULT_DIFF_TEST_SCRIPT)

.chpsimalloctest:
	@$(DUMMY_TEST_SCRIPT)

chpsimalloctest.autodepend: Makefile
	@$(ECHO) "Generating dependencies $@" ; \
	$(ECHO) "$(HACKT_CHPSIM_ALLOC_TEST_SUBJECTS)" | \
	  $(SPACES_TO_NEWLINE) | $(SORT) -u | \
	  $(AWK) '/.+/ {print $$1 ".chpsimallocdiff: $$(srcdir)/" $$1 ".expect-chpsimalloc"; }' > $@ ; \
	$(TOUCH) $@

-include chpsimalloctest.autodepend
AUTO_DEPENDS += chpsimalloctest.autodepend

# chpsim event graph tests
.chpsim-event-dot.chpsimdottest:
	@$(DUMMY_TEST_SCRIPT)

.chpsimdottest:
	@$(DUMMY_TEST_SCRIPT)

# no additional dependencies for chpsimdottest needed

# TODO: support checkpointing in test cases that pass
# NOTE: EXTRACT_HACO_PIPE is defined in "Make.test-prsim"
# TODO: extract additional command-line flags from the source script
#	maybe using @chpsim-flags@ as a match pattern
CHPSIMRC_TEST_SCRIPT = \
	obj=`$(CAT) $< | $(EXTRACT_HACO_PIPE)` ; \
	$(ECHO) "$(HACKT_CHPSIM_EXE) -b -I$(srcdir) $$obj < $<" ; \
	$(HACKT_CHPSIM_EXE) -b -I$(srcdir) "$$obj" < $< > $@ 2>&1 ; \
	$(TOUCH) $@

# the same until we add checkpointing to the pass test
CHPSIMRC_FAIL_TEST_SCRIPT = $(CHPSIMRC_TEST_SCRIPT)

.chpsimrc.chpsimrc-out:
	@$(CHPSIMRC_TEST_SCRIPT)

.chpsimrc.chpsimrcfail-out:
	-@$(CHPSIMRC_FAIL_TEST_SCRIPT)

if VERBOSE_CHECK
ECHO_CHPSIMRC_DIFF_COMMAND = $(ECHO) "$(DIFF) -bu $$expect $<"
else
ECHO_CHPSIMRC_DIFF_COMMAND = :
endif

# TODO: introduce filtering scripts and differences
.chpsimrc-out.chpsimrc-diff:
	@stderr=`$(ECHO) $@ |$(SED) 's/\.chpsimrc-diff$$/.chpsimrc-expect/g'`; \
	expect="$(srcdir)/$$stderr" ; \
	$(RM) $@ ; \
	if test -f "$$expect" ; then \
	  $(ECHO_CHPSIMRC_DIFF_COMMAND) ; \
	  $(DIFF) -bu "$$expect" $< > $@ 2>&1 ; \
	  if test -s $@ ; then \
	    $(ECHO) "$@ is non-empty!" ; \
	  fi ; \
	else $(ECHO) "Missing $$expect." | $(TEE) $@ ; \
	fi ; \
	$(TOUCH) $@

.chpsimrcfail-out.chpsimrcfail-diff:
	@stderr=`$(ECHO) $@ |$(SED) 's/\.chpsimrcfail-diff$$/.chpsimrc-expect/g'`; \
	expect="$(srcdir)/$$stderr" ; \
	$(RM) $@ ; \
	if test -f "$$expect" ; then \
	  $(ECHO_CHPSIMRC_DIFF_COMMAND) ; \
	  $(DIFF) -bu "$$expect" $< > $@ 2>&1 ; \
	  if test -s $@ ; then \
	    $(ECHO) "$@ is non-empty!" ; \
	  fi ; \
	else $(ECHO) "Missing $$expect." | $(TEE) $@ ; \
	fi ; \
	$(TOUCH) $@

# TODO: write rules for fail-tests

.chpsimrc-diff.chpsimtest:
	@$(DEFAULT_DIFF_TEST_SCRIPT)

.chpsimrcfail-diff.chpsimfailtest:
	@$(DEFAULT_DIFF_TEST_SCRIPT)

.chpsimtest:
	@$(DUMMY_TEST_SCRIPT)

.chpsimfailtest:
	@$(DUMMY_TEST_SCRIPT)

chpsimrc-out.autodepend: Makefile
	@$(ECHO) "Generating dependencies $@" ; \
	$(ECHO) -n "" > $@ ; \
	list='$(HACKT_CHPSIMRC_TEST_SCRIPTS_PASSES)' ; \
	exts='chpsimrc-out' ; \
	test -z "$$list" || \
	for d in $$list ; do \
	  src=$(srcdir)/$$d.chpsimrc ; \
	  obj=`$(CAT) "$$src" | $(EXTRACT_HACO_PIPE)` ; \
	  for e in $$exts ; do \
	    target=$$d.$$e ; \
	    $(ECHO) -n "$$target " >> $@ ; \
	  done ; \
	  $(ECHO) ": $$obj" >> $@ ; \
	done ; \
	$(TOUCH) $@

-include chpsimrc-out.autodepend
AUTO_DEPENDS += chpsimrc-out.autodepend

chpsimrcfail-out.autodepend: Makefile
	@$(ECHO) "Generating dependencies $@" ; \
	$(ECHO) -n "" > $@ ; \
	list='$(HACKT_CHPSIMRC_TEST_SCRIPTS_FAILURES)' ; \
	exts='chpsimrcfail-out' ; \
	test -z "$$list" || \
	for d in $$list ; do \
	  src=$(srcdir)/$$d.chpsimrc ; \
	  obj=`$(CAT) "$$src" | $(EXTRACT_HACO_PIPE)` ; \
	  for e in $$exts ; do \
	    target=$$d.$$e ; \
	    $(ECHO) -n "$$target " >> $@ ; \
	  done ; \
	  $(ECHO) ": $$obj" >> $@ ; \
	done ; \
	$(TOUCH) $@

-include chpsimrcfail-out.autodepend
AUTO_DEPENDS += chpsimrcfail-out.autodepend

chpsimrctest.autodepend: Makefile
	@$(ECHO) "Generating dependencies $@" ; \
	$(ECHO) "$(HACKT_CHPSIMRC_TEST_SCRIPTS_PASSES)" | \
	  $(SPACES_TO_NEWLINE) | $(SORT) -u | \
	  $(AWK) '/.+/ {print $$1 ".chpsimrc-diff: $$(srcdir)/" $$1 ".chpsimrc-expect"; }' > $@ ; \
	$(TOUCH) $@

-include chpsimrctest.autodepend
AUTO_DEPENDS += chpsimrctest.autodepend


chpsimrcfailtest.autodepend: Makefile
	@$(ECHO) "Generating dependencies $@" ; \
	$(ECHO) "$(HACKT_CHPSIMRC_TEST_SCRIPTS_FAILURES)" | \
	  $(SPACES_TO_NEWLINE) | $(SORT) -u | \
	  $(AWK) '/.+/ {print $$1 ".chpsimrcfail-diff: $$(srcdir)/" $$1 ".chpsimrc-expect"; }' > $@ ; \
	$(TOUCH) $@

-include chpsimrcfailtest.autodepend
AUTO_DEPENDS += chpsimrcfailtest.autodepend



BOGUS_TESTS += .chpsimalloctest .chpsimtest .chpsimdottest .chpsimfailtest

CHECK_SUMMARIES += chpsimallocdiffs chpsimrcdiffs chpsimrcfaildiffs
# chpsimrcdiffs chpsimrcfaildiffs 


chpsimallocdiffs: force
	-$(CAT) *.chpsimallocdiff > $@

chpsimrcdiffs: force
	-$(CAT) *.chpsimrc-diff > $@

chpsimrcfaildiffs: force
	-$(CAT) *.chpsimrcfail-diff > $@

chpsimckptdiffs: force
	-$(CAT) *.chpsimckpt-diff > $@

HACKT_CHPSIMRC_TEST_SCRIPTS_BASES = \
	$(HACKT_CHPSIMRC_TEST_SCRIPTS_PASSES) \
	$(HACKT_CHPSIMRC_TEST_SCRIPTS_FAILURES)

srcdir_EXTRA_DIST += \
	$(HACKT_CHPSIM_ALLOC_TEST_SUBJECTS:=.expect-chpsimalloc) \
	$(HACKT_CHPSIMRC_TEST_SUBJECTS:=.hac) \
	$(HACKT_CHPSIMRC_TEST_SCRIPTS_BASES:=.chpsimrc) \
	$(HACKT_CHPSIMRC_TEST_SCRIPTS_BASES:=.chpsimrc-expect)

# all alloc tests and prsimrc tests are candidates for prs-dot tests
HACKT_CHPSIM_DOT_TEST_SUBJECTS =
HACKT_CHPSIM_DOT_TEST_SUBJECTS += $(HACKT_CREATE_TEST_PASSES)
# updated to ALLOC_TEST_PASSES now?
# HACKT_CHPSIM_DOT_TEST_SUBJECTS += $(HACKT_CHPSIMRC_TEST_PASSES)

TESTS += \
	$(HACKT_CHPSIM_ALLOC_TEST_SUBJECTS:=.chpsimalloctest) \
	$(HACKT_CHPSIM_DOT_TEST_SUBJECTS:=.chpsimdottest) \
	$(HACKT_CHPSIMRC_TEST_SCRIPTS_PASSES:=.chpsimtest) \
	$(HACKT_CHPSIMRC_TEST_SCRIPTS_FAILURES:=.chpsimfailtest)

HAC_OBJECT_TARGETS += \
	$(HACKT_CHPSIMRC_TEST_SUBJECTS:=.haco) \
	$(HACKT_CHPSIMRC_TEST_SUBJECTS:=.haco-c) \
	$(HACKT_CHPSIMRC_TEST_SUBJECTS:=.haco-a) \
	$(HACKT_CHPSIM_ALLOC_TEST_SUBJECTS:=.haco-c) \
	$(HACKT_CHPSIM_ALLOC_TEST_SUBJECTS:=.haco-a)

build-check-local: \
	$(HACKT_CHPSIM_ALLOC_TEST_SUBJECTS:=.haco-a) \
	$(HACKT_CHPSIM_ALLOC_TEST_SUBJECTS:=.chpsimallocdump) \
	$(HACKT_CHPSIM_DOT_TEST_SUBJECTS:=.chpsim-event-dot) \
	$(HACKT_CHPSIM_DOT_TEST_SUBJECTS:=.chpsimdottest) \
	$(HACKT_CHPSIMRC_TEST_SUBJECTS:=.haco-a) \
	$(HACKT_CHPSIMRC_TEST_SCRIPTS_PASSES:=.chpsimrc-out) \
	$(HACKT_CHPSIMRC_TEST_SCRIPTS_PASSES:=.chpsimrc-diff) \
	$(HACKT_CHPSIMRC_TEST_SCRIPTS_FAILURES:=.chpsimrcfail-out) \
	$(HACKT_CHPSIMRC_TEST_SCRIPTS_FAILURES:=.chpsimrcfail-diff)

ALL_CHPSIM_DOT = $(HACKT_CHPSIM_DOT_TEST_SUBJECTS:=.chpsim-event-dot)
ALL_CHPSIM_PS = $(HACKT_CHPSIM_DOT_TEST_SUBJECTS:=.chpsim-event-ps)

$(ALL_CHPSIM_DOT): $(HACKT_EXE)

all-chpsim-dot: $(ALL_CHPSIM_DOT)

all-chpsim-ps: $(ALL_CHPSIM_PS)

clean-chpsim-dot: force
	-$(RM) $(ALL_CHPSIM_DOT)

clean-chpsim-ps: force
	-$(RM) $(ALL_CHPSIM_PS)

echo-chpsimalloc-tests: force
	@$(ECHO) $(HACKT_CHPSIM_ALLOC_TEST_SUBJECTS)

echo-chpsimdot-tests: force
	@$(ECHO) $(HACKT_CHPSIM_DOT_TEST_SUBJECTS)

echo-chpsimrc-passes: force
	@$(ECHO) $(HACKT_CHPSIMRC_TEST_SCRIPTS_PASSES)

echo-chpsimrc-failures: force
	@$(ECHO) $(HACKT_CHPSIMRC_TEST_SCRIPTS_FAILURES)


clean-chpsimtests:
	-$(RM_PATTERN) "*.chpsimallocdump"
	-$(RM_PATTERN) "*.chpsimallocdiff"
	-$(RM_PATTERN) "*.chpsimalloctest"
	-$(RM_PATTERN) "*.chpsim-event-dot"
	-$(RM_PATTERN) "*.chpsim-event-ps"
	-$(RM_PATTERN) "*.chpsimdottest"
	-$(RM_PATTERN) "*.chpsimrc-out"
	-$(RM_PATTERN) "*.chpsimrc-diff"
	-$(RM_PATTERN) "*.chpsimtest"
	-$(RM_PATTERN) "*.chpsimrcfail-out"
	-$(RM_PATTERN) "*.chpsimrcfail-diff"
	-$(RM_PATTERN) "*.chpsimfailtest"

clean-local: clean-chpsimtests

.PHONY: clean-chpsimtests all-chpsim-dot all-chpsim-ps

