#!@SH_PATH@
# "hackt-cflat-expect.sh.in"
#	$Id: hackt-cflat-expect.sh.in,v 1.11 2006/02/05 03:26:11 fang Exp $

# NOTE: temporarily just uses stdout dump during execution
# will updated later...

# $1 is the executable for the creator (hackt alloc), expecting 2 arguments
# $2 is the path to the source directory, which is not necessarily ./
#	during distcheck uses _build
# $3 is the input file name WITHOUT the .in extension
# other subsequent arguments are ignored

# if test $# -lt 3 ; then exit 1 ; fi

cflat=$1
srcroot=$2/$3
bldroot=$3

# a pre-created (already created) object file must already exist
if test ! -s $bldroot.haco-a
then
	@ECHO@ "$bldroot.haco-a doesn't exist or is empty."
	exit 1
fi

# see if it crashes first
$cflat $bldroot.haco-a > $bldroot.prs

# depending on exit status, take action
case $? in
	0) break ;;
	*) exit 1 ;;
esac

# .allocstderr comparison file must exist
if test ! -f $srcroot.expect-prs && test ! -f $bldroot.expect-prs
then
	@ECHO@ "Missing $srcroot.expect-prs"
	exit 1
fi

# some PRS may be empty
if test -s $srcroot.expect-prs
then
	@DIFF@ -u $srcroot.expect-prs $bldroot.prs > $bldroot.prsdiff
else
	@DIFF@ -u $bldroot.expect-prs $bldroot.prs > $bldroot.prsdiff
fi

if test -s $bldroot.prsdiff
then
	@ECHO@ "$bldroot.prsdiff is non-empty!"
	# additional analysis to see if is just re-ordering difference
	if test -s $srcroot.expect-prs && test -s $bldroot.prs
	then
		@SORT@ $srcroot.expect-prs > $bldroot.expect-prs.sort
		@SORT@ $bldroot.prs > $bldroot.prs.sort
		@DIFF@ -u $bldroot.expect-prs.sort $bldroot.prs.sort \
			> $bldroot.prsdiff.sort
		if test ! -s $bldroot.prsdiff.sort
		then
			@ECHO@ "Only re-ordering differencies found.  (OK)"
		fi
	fi
	exit 1
# we've added some test macros that will break prsim
# so we make exceptions for those tests
@HAVE_PRSIM_TRUE@else
@HAVE_PRSIM_TRUE@case $bldroot in
@HAVE_PRSIM_TRUE@echo* ) ;;
@HAVE_PRSIM_TRUE@macro* ) ;;
@HAVE_PRSIM_TRUE@spec* ) ;;
@HAVE_PRSIM_TRUE@* )
@HAVE_PRSIM_TRUE@	@PRSIM@ $bldroot.prs < /dev/null > /dev/null 2>&1
@HAVE_PRSIM_TRUE@	if test $? -ne 0
@HAVE_PRSIM_TRUE@	then
@HAVE_PRSIM_TRUE@		@ECHO@ "Error: @PRSIM@ rejected $bldroot.prs."
@HAVE_PRSIM_TRUE@		exit 1
@HAVE_PRSIM_TRUE@	fi
@HAVE_PRSIM_TRUE@;;
@HAVE_PRSIM_TRUE@esac
fi

