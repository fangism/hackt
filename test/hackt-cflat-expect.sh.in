#!@SH_PATH@
# "hackt-cflat-expect.sh.in"
#	$Id: hackt-cflat-expect.sh.in,v 1.2 2005/10/08 01:40:04 fang Exp $

# NOTE: tepomrarily just uses stdout dump during execution
# will updated later...

# $1 is the executable for the creator (hackt alloc), expecting 2 arguments
# $2 is the path to the source directory, which is not necessarily ./
#	during distcheck uses _build
# $3 is the input file name WITHOUT the .in extension
# $4 is the test report log file, summarizing results
# other subsequent arguments are ignored

# if [ $# -lt 5 ] ; then exit 1 ; fi

cflat=$1
srcroot=$2/$3
bldroot=$3
logfile=$4

# a pre-created (already created) object file must already exist
if ! [ -s $bldroot.hacktobjalloc ]
then
	@ECHO@ "$bldroot.hacktobjalloc doesn't exist or is empty."
	exit 1
fi

# see if it crashes first
$cflat $bldroot.hacktobjalloc > $bldroot.prs

# depending on exit status, take action
case $? in
	0) break ;;
	*) exit 1 ;;
esac

# .allocstderr comparison file must exist
if ! [ -f $srcroot.expect-prs ]
then
	@ECHO@ "Missing $srcroot.expect-prs"
	exit 1
fi

# ignore whitespace differences
@DIFF@ $srcroot.expect-prs $bldroot.prs > $bldroot.prsdiff

if [ -s $bldroot.prsdiff ]
then
	@ECHO@ "$bldroot.prsdiff is non-empty!  See $logfile."
	@ECHO@ `pwd`/"$bldroot.prsdiff" >> $logfile
	exit 1
@HAVE_PRSIM_TRUE@else
@HAVE_PRSIM_TRUE@	@PRSIM@ $bldroot.prs < /dev/null > /dev/null
@HAVE_PRSIM_TRUE@	if [ $? -ne 0 ]
@HAVE_PRSIM_TRUE@	then
@HAVE_PRSIM_TRUE@		@ECHO@ "Error: @PRSIM@ rejected $bldroot.prs."
@HAVE_PRSIM_TRUE@		exit 1
@HAVE_PRSIM_TRUE@	fi
fi

