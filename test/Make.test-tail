# "test/Make.test-tail"
# a template makefile for testing, to be included in recursive invocations
# Include this Makefile at the end of every subdirectoy's Makefile.am.
# The counterpart header Makefile is "test/Make.test-head".
#	$Id: Make.test-tail,v 1.11.2.6 2005/12/13 02:58:41 fang Exp $

PARSE_TEST_EXE = $(top_builddir)/src/hackt parse_test
HACKT_COMPILE_EXE = $(top_builddir)/src/hackt compile
HACKT_OBJDUMP_EXE = $(top_builddir)/src/hackt objdump
HACKT_UNROLL_EXE = $(top_builddir)/src/hackt unroll
HACKT_CREATE_EXE = $(top_builddir)/src/hackt create
HACKT_ALLOC_EXE = $(top_builddir)/src/hackt alloc
HACKT_CFLAT_PRSIM_EXE = $(top_builddir)/src/hackt cflat prsim

# NOTE: these scripts are configure-generated from their .hac files.  
HACKT_PARSE_TEST_SH = $(top_builddir)/test/parse-test-expect.sh
HACKT_OBJ_TEST_SH = $(top_builddir)/test/hackt-obj-diff.sh
HACKT_UNROLL_TEST_SH = $(top_builddir)/test/hackt-unroll-expect.sh
HACKT_CREATE_TEST_SH = $(top_builddir)/test/hackt-create-expect.sh
HACKT_ALLOC_TEST_SH = $(top_builddir)/test/hackt-alloc-expect.sh
HACKT_CFLAT_TEST_SH = $(top_builddir)/test/hackt-cflat-expect.sh

HACKT_COMPILE_ERROR_FILTER = $(AWK) \
		-f $(top_srcdir)/test/hackt-parse-expect-filter.awk \
		-f $(top_srcdir)/test/state_enum_filter.awk \
		-f $(top_srcdir)/test/vpath_file_filter.awk
POM_HEADER_FILTER = $(AWK) -f $(top_srcdir)/test/POM-header-filter.awk
POM_INDEX_FILTER = $(AWK) -f $(top_srcdir)/test/POM-index-filter.awk
HEX_ADDRESS_FILTER = $(SED) -f $(top_srcdir)/test/address_filter.sed
ALLOC_FILTER = $(SED) -f $(top_srcdir)/test/alloc_filter.sed
HACKT_OBJ_DIFF_FILTER = $(POM_HEADER_FILTER)
ANALYZE_DIFF_AWK = $(AWK) -f $(top_srcdir)/test/analyze-dump-diff.awk

# TODO: phase out TEST_REPORT, we already have check.log
# also get rid of subdir.not_a_test
TEST_REPORT = $(top_builddir)/test/test-report.txt

# These needs to be specified in Makefile.am to take effect
# SUFFIXES = .hac .hacktcmpltest .hacktobjtest .hacktunrolltest
#	.hacktcreatetest .hacktalloctest .hacktcflattest

.hac.stderr:
	@$(TOUCH) $@

subdir.not_a_test:
	@$(ECHO) "#!$(SHELL)" > $@
	@$(ECHO) "echo \"In $(subdir):\" >> $(TEST_REPORT)" >> $@
	@$(CHMOD) +x $@

.hac.hacktcmpltest:
	@$(ECHO) "#!$(SHELL)" > $@
	@$(ECHO) "# \"$@\"" >> $@
	@$(ECHO) $(HACKT_PARSE_TEST_SH) "\"$(PARSE_TEST_EXE)\"" $(srcdir) $* \
		"\"$(HACKT_COMPILE_ERROR_FILTER)\"" $(TEST_REPORT) >> $@
	@$(CHMOD) +x $@

.hac.hacktobjtest:
	@$(ECHO) "#!$(SHELL)" > $@
	@$(ECHO) "# \"$@\"" >> $@
	@$(ECHO) $(HACKT_OBJ_TEST_SH) "\"$(HACKT_COMPILE_EXE)\"" \
		"\"$(HACKT_OBJDUMP_EXE)\"" $(srcdir) \
		$* "\"$(HACKT_OBJ_DIFF_FILTER)\"" $(TEST_REPORT) >> $@
	@$(CHMOD) +x $@

.hac.hacktunrolltest:
	@$(ECHO) "#!$(SHELL)" > $@
	@$(ECHO) "# \"$@\"" >> $@
	@$(ECHO) $(HACKT_UNROLL_TEST_SH) "\"$(HACKT_UNROLL_EXE)\"" \
		"\"$(HACKT_OBJDUMP_EXE)\"" $(srcdir) \
		$* "\"$(HACKT_OBJ_DIFF_FILTER)\"" $(TEST_REPORT) \
		"\"$(ANALYZE_DIFF_AWK)\"" \
		"\"$(POM_INDEX_FILTER)\"" >> $@
	@$(CHMOD) +x $@

.hac.hacktcreatetest:
	@$(ECHO) "#!$(SHELL)" > $@
	@$(ECHO) "# \"$@\"" >> $@
	@$(ECHO) $(HACKT_CREATE_TEST_SH) "\"$(HACKT_CREATE_EXE)\"" \
		"\"$(HACKT_OBJDUMP_EXE)\"" $(srcdir) \
		$* "\"$(HACKT_OBJ_DIFF_FILTER)\"" $(TEST_REPORT) \
		"\"$(ANALYZE_DIFF_AWK)\"" \
		"\"$(POM_INDEX_FILTER)\"" >> $@
	@$(CHMOD) +x $@

.hac.hacktalloctest:
	@$(ECHO) "#!$(SHELL)" > $@
	@$(ECHO) "# \"$@\"" >> $@
	@$(ECHO) $(HACKT_ALLOC_TEST_SH) "\"$(HACKT_ALLOC_EXE)\"" \
		"\"$(HACKT_OBJDUMP_EXE)\"" $(srcdir) \
		$* "\"$(ALLOC_FILTER)\"" $(TEST_REPORT) \
		"\"$(ANALYZE_DIFF_AWK)\"" \
		"\"$(POM_INDEX_FILTER)\"" >> $@
	@$(CHMOD) +x $@

.hac.hacktcflattest:
	@$(ECHO) "#!$(SHELL)" > $@
	@$(ECHO) "# \"$@\"" >> $@
	@$(ECHO) $(HACKT_CFLAT_TEST_SH) "\"$(HACKT_CFLAT_PRSIM_EXE)\"" \
		$(srcdir) $* $(TEST_REPORT) >> $@
	@$(CHMOD) +x $@

CHECK_SUMMARIES = compilediffs objdiffs unrolldiffs creatediffs allocdiffs \
	unrolldiffs.noindex creatediffs.noindex allocdiffs.noindex \
	prsdiffs prsdiffs.sort
# need prs summaries? nah...

compilediffs: force
	-$(CAT) *.diff > $@

objdiffs: force
	-$(CAT) *.objdiff > $@

unrolldiffs: force
	-$(CAT) *.unrolldiff > $@

creatediffs: force
	-$(CAT) *.creatediff > $@

allocdiffs: force
	-$(CAT) *.allocdiff > $@

prsdiffs: force
	-$(CAT) *.prsdiff > $@

unrolldiffs.noindex: force
	-$(CAT) *.unrolldiff.noindex > $@

creatediffs.noindex: force
	-$(CAT) *.creatediff.noindex > $@

allocdiffs.noindex: force
	-$(CAT) *.allocdiff.noindex > $@

prsdiffs.sort: force
	-$(CAT) *.prsdiff.sort > $@

check-summaries: $(CHECK_SUMMARIES)
	-@ls -l $(CHECK_SUMMARIES)

# must be previously defined to use +=
# assuming HACKT_OBJ_TEST_SUBJECTS is subset of HACKT_PARSE_TEST_SUBJECTS
EXTRA_DIST += $(HACKT_PARSE_TEST_SUBJECTS:=.hac) \
	$(HACKT_PARSE_TEST_FAILURES:=.stderr) \
	$(BISON_OUTPUTS:=.stderr.bison) \
	$(HACKT_UNROLL_TEST_SUBJECTS:=.unrollstderr) \
	$(HACKT_CREATE_TEST_SUBJECTS:=.createstderr) \
	$(HACKT_ALLOC_TEST_SUBJECTS:=.allocstderr) \
	$(HACKT_CFLAT_TEST_SUBJECTS:=.expect-prs) 

TESTS += $(HACKT_PARSE_TEST_SUBJECTS:=.hacktcmpltest) \
	$(HACKT_OBJ_TEST_SUBJECTS:=.hacktobjtest) \
	$(HACKT_UNROLL_TEST_SUBJECTS:=.hacktunrolltest) \
	$(HACKT_CREATE_TEST_SUBJECTS:=.hacktcreatetest) \
	$(HACKT_ALLOC_TEST_SUBJECTS:=.hacktalloctest) \
	$(HACKT_CFLAT_TEST_SUBJECTS:=.hacktcflattest) 

EMPTY_CFLAT_PRS = $(EMPTY_CFLAT_PRS_TESTS:=.expect-prs)

clean-empty-cflat-prs:
	-test -z "$(EMPTY_CFLAT_PRS)" || $(RM) $(EMPTY_CFLAT_PRS)

# need a bogus dependency to make it work...
$(EMPTY_CFLAT_PRS): Makefile
	@touch $@

# echo-style Makefile debugging
echo-tests: force
	@$(ECHO) $(TESTS)

echo-compile-passes: force
	@$(ECHO) $(HACKT_PARSE_TEST_PASSES)

echo-bison-outputs: force
	@$(ECHO) $(BISON_OUTPUTS)

echo-empty-cflat-prs: force
	@$(ECHO) $(EMPTY_CFLAT_PRS)

# filter-out is GNUMake feature
#	$($(filter-out $(HACKT_PARSE_TEST_PASSES), $(HACKT_PARSE_TEST_SUBJECTS)):=.stderr)

# must be previously defined
CLEANFILES += $(TESTS) $(CHECK_SUMMARIES) \
	$(HACKT_PARSE_TEST_SUBJECTS:=.diff) \
	$(HACKT_PARSE_TEST_SUBJECTS:=.test) \
	$(HACKT_PARSE_TEST_SUBJECTS:=.test.filter) \
	$(HACKT_PARSE_TEST_SUBJECTS:=.stderr.filter) \
	$(HACKT_PARSE_TEST_PASSES:=.stderr) \
	$(BISON_OUTPUTS:=.stderr.bison.filter) \
	$(BISON_OUTPUTS:=.bison.diff) \
	$(HACKT_OBJ_TEST_SUBJECTS:=.outdump) \
	$(HACKT_OBJ_TEST_SUBJECTS:=.indump) \
	$(HACKT_OBJ_TEST_SUBJECTS:=.outdump.filter) \
	$(HACKT_OBJ_TEST_SUBJECTS:=.indump.filter) \
	$(HACKT_OBJ_TEST_SUBJECTS:=.haco) \
	$(HACKT_OBJ_TEST_SUBJECTS:=.objdiff) \
	$(HACKT_UNROLL_TEST_SUBJECTS:=.haco-u) \
	$(HACKT_UNROLL_TEST_SUBJECTS:=.unrolldump) \
	$(HACKT_UNROLL_TEST_SUBJECTS:=.unrolldump.filter) \
	$(HACKT_UNROLL_TEST_SUBJECTS:=.unrolldiff) \
	$(HACKT_CREATE_TEST_SUBJECTS:=.haco-c) \
	$(HACKT_CREATE_TEST_SUBJECTS:=.createdump) \
	$(HACKT_CREATE_TEST_SUBJECTS:=.createdump.filter) \
	$(HACKT_CREATE_TEST_SUBJECTS:=.creatediff) \
	$(HACKT_ALLOC_TEST_SUBJECTS:=.haco-a) \
	$(HACKT_ALLOC_TEST_SUBJECTS:=.allocdump) \
	$(HACKT_ALLOC_TEST_SUBJECTS:=.allocdump.filter) \
	$(HACKT_ALLOC_TEST_SUBJECTS:=.allocdiff) \
	$(HACKT_CFLAT_TEST_SUBJECTS:=.prs) \
	$(HACKT_CFLAT_TEST_SUBJECTS:=.prsdiff) \
	$(EMPTY_CFLAT_PRS)


DISTCLEANFILES += local.cvsignore subdir.not_a_test

all-local: .cvsignore subdir.not_a_test \
	$(HACKT_PARSE_TEST_PASSES:=.stderr) $(TESTS) \
	$(EMPTY_CFLAT_PRS)

# consider using CLEANFILES
AUTO_IGNORE += local.cvsignore \
	$(HACKT_PARSE_TEST_PASSES:=.stderr) \
	$(HACKT_UNROLL_TEST_SUBJECTS:=.hacktunrolltest) \
	$(HACKT_CREATE_TEST_SUBJECTS:=.hacktcreatetest) \
	$(HACKT_ALLOC_TEST_SUBJECTS:=.hacktalloctest) \
	$(HACKT_CFLAT_TEST_SUBJECTS:=.hacktcflattest) \
	$(EMPTY_CFLAT_PRS) \
	$(CHECK_SUMMARIES)

# we generate all the local.cvsignore's in the test directories
local.cvsignore: $(top_srcdir)/test/test.cvsignore
	$(CP) $? $@

# additional dependence
.cvsignore: $(top_srcdir)/test/Make.test-tail

# clean tests only
clean-tests: clean-tests-recursive
	-$(RM) $(TESTS)

# doesn't work... consider recursive automake for EXTRA_RECURSIVE_TARGETS
# RECURSIVE_TARGETS += clean-tests-recursive

clean-tests-recursive:
	@for d in $(SUBDIRS) ; do \
		if test $$d != . ; then \
			if test -d $$d ; then \
				$(MAKE) -C $$d clean-tests ; \
			fi ; \
		fi ; \
	done

# automatically removes $(CLEANFILES)
clean-local:
	-$(RM) *.core core.*
	-$(RM) *.noindex

# really remove these files!
cleaner: clean cleaner-recursive cleaner-local

cleaner-local:
	-$(RM) *.filter *.diff *.sort *.noindex
	-$(RM) *.hacktcmpltest *.hacktobjtest *.hacktunrolltest
	-$(RM) *.hacktcreatetest *.hacktalloctest
	-$(RM) *.indump *.outdump *.objdiff
	-$(RM) *.haco
	-$(RM) *.haco-u *.unrolldump *.unrolldiff
	-$(RM) *.haco-c *.createdump *.creatediff
	-$(RM) *.haco-a *.allocdump *.allocdiff
	-$(RM) *.prs *.prsdiff
# legacy object files
	-$(RM) *.artobj *.artobjunroll *.hacktobjcreate *.hacktobjalloc

distclean-local: cleaner-local

cleaner-recursive:
	@subdirs='$(SUBDIRS)'; \
	for d in $$subdirs ; do \
		if test $$d != . ; then \
			if test -d $$d ; then \
				$(MAKE) -C $$d cleaner ; \
			fi ; \
		fi ; \
	done

.PHONY: cleaner cleaner-local cleaner-recursive \
	clean-tests clean-tests-recursive

# some stderr files don't exist, because empty output files are optional
# this shouldn't really be necessary...
# dist-hook-extra:
#	$(RM) $(distdir)/subdir.not_a_test

# this cheat is only needed to create auto-generated (empty) distribution files
# dist-hook-missing: $(EXTRA_DIST)
#	@for f in $(EXTRA_DIST); do \
#		if test ! -f $$f ; then \
#			$(TOUCH) $$f ; \
#		fi ; \
#	done

include $(top_srcdir)/Make.global

