# "test/Make.test"
# a template makefile for testing, to be included in recursive invocations

include $(top_srcdir)/Make.stddef

ARTC_EXE = $(top_builddir)/src/artc
ART2OBJ_EXE = $(top_builddir)/src/art++2obj
ARTODUMP_EXE = $(top_builddir)/src/artobjdump

ARTC_TEST_SH = $(top_srcdir)/test/artc-expect.sh
ARTOBJ_TEST_SH = $(top_srcdir)/test/artobj-diff.sh

STATE_ENUM_FILTER = $(AWK) -f $(top_srcdir)/test/state_enum_filter.awk
ARTOBJ_DIFF_FILTER = $(SED) -f $(top_srcdir)/test/address_filter.sed

TEST_REPORT = $(top_builddir)/test/test-report.txt

# This needs to be specified in Makefile.am to take effect
# SUFFIXES = .in .artctest .artobjtest

.in.stderr:
	@$(TOUCH) $@

subdir.not_a_test:
	@$(ECHO) "#!$(SHELL)" > $@
	@$(ECHO) "echo \"In $(subdir):\" >> $(TEST_REPORT)" >> $@
	@$(CHMOD) a+x $@

.in.artctest:
	@$(ECHO) "#!$(SHELL)" > $@
	@$(ECHO) "# \"$@\"" >> $@
	@$(ECHO) $(ARTC_TEST_SH) $(ARTC_EXE) $(srcdir) $* \
		"\"$(STATE_ENUM_FILTER)\"" $(TEST_REPORT) >> $@
	@$(CHMOD) a+x $@

.in.artobjtest:
	@$(ECHO) "#!$(SHELL)" > $@
	@$(ECHO) "# \"$@\"" >> $@
	@$(ECHO) $(ARTOBJ_TEST_SH) $(ART2OBJ_EXE) $(ARTODUMP_EXE) $(srcdir) \
		$* "\"$(ARTOBJ_DIFF_FILTER)\"" $(TEST_REPORT) >> $@
	@$(CHMOD) a+x $@

# must be previously defined
EXTRA_DIST += $(ARTC_TEST_SUBJECTS:=.in) $(ARTC_TEST_SUBJECTS:=.stderr) \
	$(BISON_OUTPUTS:=.stderr.bison)
# assuming ARTOBJ_TEST_SUBJECTS is subset of ARTC_TEST_SUBJECTS

# must be previously defined
CLEANFILES += $(TESTS) subdir.not_a_test \
	$(ARTC_TEST_SUBJECTS:=.diff) \
	$(ARTC_TEST_SUBJECTS:=.test) \
	$(ARTC_TEST_SUBJECTS:=.test.filter) \
	$(ARTC_TEST_SUBJECTS:=.stderr.filter) \
	$(BISON_OUTPUTS:=.stderr.bison.filter) \
	$(BISON_OUTPUTS:=.stderr.bison.diff) \
	$(ARTOBJ_TEST_SUBJECTS:=.outdump) \
	$(ARTOBJ_TEST_SUBJECTS:=.indump) \
	$(ARTOBJ_TEST_SUBJECTS:=.outdump.filter) \
	$(ARTOBJ_TEST_SUBJECTS:=.indump.filter) \
	$(ARTOBJ_TEST_SUBJECTS:=.artobj) \
	$(ARTOBJ_TEST_SUBJECTS:=.objdiff)

all-local: subdir.not_a_test $(TESTS)

# automatically removes $(CLEANFILES)
clean-local:
	-$(RM) *.core core.*
	-$(RM) *.filter *.diff

# some stderr files don't exist, because empty output files are optional
# this shouldn't really be necessary...
# dist-hook-extra:
#	$(RM) $(distdir)/subdir.not_a_test

dist-hook-missing: $(EXTRA_DIST)
	@for f in $(EXTRA_DIST); do \
		if ! [ -f $$f ] ; then \
			$(TOUCH) $$f ; \
		fi ; \
	done

