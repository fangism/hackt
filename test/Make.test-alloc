# "Make.test-alloc"
#	vi: ft=automake
#	$Id: Make.test-alloc,v 1.4 2006/12/01 23:29:00 fang Exp $
# This is just a portion of the Make.test-tail template included by
# Makefile.am's in the test/ directory subtree.  
# This depends on variables defined in Make.test-tail, and thus, 
# should not be included by itself.  

# obsolete:
# HACKT_ALLOC_TEST_SH = $(TEST_BUILDDIR)/hackt-alloc-expect.sh
# HACKT_ALLOC_FROM_HACO_TEST_SH = $(TEST_BUILDDIR)/check-alloc-consistency.sh


ALLOC_FILTER = $(SED) -f $(TEST_SRCDIR)/alloc_filter.sed

# ALLOC tests
.haco-c.haco-a:
	$(HACKT_ALLOC_EXE) $< $@

.haco.haco-a-from-haco:
	$(HACKT_ALLOC_EXE) $< $@

if USE_UNROLL_PHASE
.haco-u.haco-a-from-u:
	$(HACKT_ALLOC_EXE) $< $@
endif

.haco-a.haco-a-dump:
	$(DEFAULT_OBJDUMP_RULE_ACTION)

.haco-a.allocdump:
	$(DEFAULT_OBJDUMP_RULE_ACTION)

.haco-a-from-haco.haco-a-from-haco-dump:
	$(DEFAULT_OBJDUMP_RULE_ACTION)

if USE_UNROLL_PHASE
.haco-a-from-u.haco-a-from-u-dump:
	$(DEFAULT_OBJDUMP_RULE_ACTION)
endif

if VERBOSE_CHECK
ALLOCDUMP_FILTER_SCRIPT = $(CAT) $< | $(ALLOC_FILTER) > $@
else
ALLOCDUMP_FILTER_SCRIPT = @$(CAT) $< | $(ALLOC_FILTER) > $@
endif

.haco-a-dump.haco-a-dump-filter:
	$(ALLOCDUMP_FILTER_SCRIPT)

.allocdump.allocdump-filter:
	$(ALLOCDUMP_FILTER_SCRIPT)

.haco-a-from-haco-dump.haco-a-from-haco-filter:
	$(ALLOCDUMP_FILTER_SCRIPT)

if USE_UNROLL_PHASE
.haco-a-from-u-dump.haco-a-from-u-filter:
	$(ALLOCDUMP_FILTER_SCRIPT)
endif

if VERBOSE_CHECK
ECHO_ALLOCDUMP_DIFF_COMMAND = $(ECHO) "$(DIFF) -bu $$""(srcdir)/$$stderr $<"
else
ECHO_ALLOCDUMP_DIFF_COMMAND = :
endif

.allocdump-filter.allocdiff:
	@stderr=`$(ECHO) $@ | $(SED) 's/\.allocdiff$$/.allocstderr/g'` ; \
	expect=$(srcdir)/$$stderr ; \
	$(RM) $@ ; \
	if test -f "$$expect" ; then \
	  $(ECHO_ALLOCDUMP_DIFF_COMMAND) ; \
	  $(DIFF) -bu "$$expect" $< > $@ 2>&1 ; \
	  if test -s $@ ; then $(ECHO) "$@ is non-empty!" ; fi ; \
	else $(ECHO) "Missing $$expect." | $(TEE) $@ ; \
	fi ; \
	$(TOUCH) $@

.allocdiff.hacktalloctest:
	@$(DEFAULT_DIFF_TEST_SCRIPT)

alloctest.autodepend: Makefile
	@$(ECHO) "Generating dependencies $@" ; \
	$(ECHO) "$(HACKT_ALLOC_TEST_PASSES)" | \
		$(SPACESTONEWLINE) | $(SORT) -u | \
		$(AWK) '{print $$1 ".allocdiff: $$(srcdir)/" $$1 ".allocstderr"; }' > $@ ; \
	$(TOUCH) $@

-include alloctest.autodepend

.hacktalloctest:
	@$(DUMMY_TEST_SCRIPT)

.haco-c.allocfaildump:
	-@failobj=`$(ECHO) $@ | $(SED) 's/\.allocfaildump$$/.haco-a-fail/g'` ; \
	$(ECHO) $(HACKT_ALLOC_EXE) $< "$$failobj" ; \
	$(HACKT_ALLOC_EXE) $< "$$failobj" > $@ 2>&1

if VERBOSE_CHECK
ECHO_ALLOCFAIL_DIFF_COMMAND = $(ECHO) "$(DIFF) -bu $$""(srcdir)/$$stderr $<"
else
ECHO_ALLOCFAIL_DIFF_COMMAND = :
endif

.allocfaildump.allocfaildiff:
	@stderr=`$(ECHO) $@ | $(SED) 's/\.allocfaildiff$$/.allocstderr/g'` ; \
	expect=$(srcdir)/$$stderr ; \
	$(RM) $@ ; \
	if test -f "$$expect" ; then \
	  $(ECHO_ALLOCFAIL_DIFF_COMMAND) ; \
	  $(DIFF) -bu "$$expect" $< > $@ 2>&1 ; \
	  if test -s $@ ; then \
	    $(ECHO) "$@ is non-empty!" ; \
	  fi ; \
	else $(ECHO) "Missing $$expect." | $(TEE) $@ ; \
	fi ; \
	$(TOUCH) $@

.allocfaildiff.hacktallocfailtest:
	@$(DEFAULT_DIFF_TEST_SCRIPT)

allocfailtest.autodepend: Makefile
	@$(ECHO) "Generating dependencies $@" ; \
	$(ECHO) "$(HACKT_ALLOC_TEST_FAILURES)" | \
		$(SPACESTONEWLINE) | $(SORT) -u | \
		$(AWK) '{print $$1 ".allocfaildiff: $$(srcdir)/" $$1 ".allocstderr"; }' > $@ ; \
	$(TOUCH) $@

-include allocfailtest.autodepend


# .hac.hacktalloctest:
#	@$(ECHO) "#!$(SHELL)" > $@
#	@$(ECHO) "# \"$@\"" >> $@
#	@$(ECHO) $(HACKT_ALLOC_TEST_SH) "\"$(HACKT_ALLOC_EXE)\"" \
#		"\"$(HACKT_OBJDUMP_EXE)\"" $(srcdir) \
#		$* "\"$(ALLOC_FILTER)\"" \
#		"\"$(ANALYZE_DIFF_AWK)\"" \
#		"\"$(POM_INDEX_FILTER)\"" >> $@
#	@$(CHMOD) +x $@

# does a 3-way difference test
# .hac.hacktallocfromhacotest:
#	@$(ECHO) "#!$(SHELL)" > $@
#	@$(ECHO) "# \"$@\"" >> $@
#	@$(ECHO) $(HACKT_ALLOC_FROM_HACO_TEST_SH) "\"$(HACKT_ALLOC_EXE)\"" \
#		"\"$(HACKT_OBJDUMP_EXE)\"" $(srcdir) \
#		$* "\"$(ALLOC_FILTER)\"" >> $@
#	@$(CHMOD) +x $@

.haco-a-from-haco.alloc-from-haco-dump:
	$(DEFAULT_OBJDUMP_RULE_ACTION)

if USE_UNROLL_PHASE
.haco-a-from-u.alloc-from-u-dump:
	$(DEFAULT_OBJDUMP_RULE_ACTION)
endif

.alloc-from-haco-dump.alloc-from-haco-dump-filter:
	@$(CAT) $< | $(ALLOC_FILTER) > $@ ; \
	$(ECHO_FILTERED)

if USE_UNROLL_PHASE
.alloc-from-u-dump.alloc-from-u-dump-filter:
	@$(CAT) $< | $(ALLOC_FILTER) > $@ ; \
	$(ECHO_FILTERED)
endif

if VERBOSE_CHECK
ECHO_ALLOCFROMHACO_DIFF_COMMAND = \
	$(ECHO) "$(DIFF) -bu $$expect1 $<" ; $(ECHO) "$(DIFF) -bu $$expect2 $<"
else
ECHO_ALLOCFROMHACO_DIFF_COMMAND = :
endif

# unifies 3-way diff
.alloc-from-haco-dump-filter.alloc-from-haco-diff:
if USE_UNROLL_PHASE
	@expect1=`$(ECHO) $@ | $(SED) 's/\.alloc-from-haco-diff$$/.allocdump-filter/g'` ; \
	expect2=`$(ECHO) $@ | $(SED) 's/\.alloc-from-haco-diff$$/.alloc-from-u-dump-filter/g'` ; \
	$(RM) $@ ; \
	if test -f "$$expect1" ; then \
	  if test -f "$$expect2" ; then \
	    $(ECHO_ALLOCFROMHACO_DIFF_COMMAND) ; \
	    $(DIFF) -bu "$$expect1" $< >> $@ 2>&1 ; \
	    $(DIFF) -bu "$$expect2" $< >> $@ 2>&1 ; \
	    if test -s $@ ; then \
	      $(ECHO) "$@ is non-empty!" ; \
	    fi ; \
	  else $(ECHO) "Missing $$expect2." | $(TEE) $@ ; \
	  fi ; \
	else $(ECHO) "Missing $$expect1." | $(TEE) $@ ; \
	fi ; \
	$(TOUCH) $@
else
	@expect1=`$(ECHO) $@ | $(SED) 's/\.alloc-from-haco-diff$$/.allocdump-filter/g'` ; \
	$(RM) $@ ; \
	if test -f "$$expect1" ; then \
	  $(ECHO_ALLOCFROMHACO_DIFF_COMMAND) ; \
	  $(DIFF) -bu "$$expect1" $< >> $@ 2>&1 ; \
	  if test -s $@ ; then \
	    $(ECHO) "$@ is non-empty!" ; \
	  fi ; \
	else $(ECHO) "Missing $$expect1." | $(TEE) $@ ; \
	fi ; \
	$(TOUCH) $@
endif

allocfromhaco.autodepend: Makefile
if USE_UNROLL_PHASE
	@$(ECHO) "Generating dependencies $@" ; \
	$(ECHO) "$(HACKT_ALLOC_TEST_PASSES)" | \
	  $(SPACESTONEWLINE) | $(SORT) -u | \
	  $(AWK) '{print $$1 ".alloc-from-haco-diff: " $$1 ".allocdump-filter " $$1 ".alloc-from-u-dump-filter"; }' > $@ ; \
	$(TOUCH) $@
else
	@$(ECHO) "Generating dependencies $@" ; \
	$(ECHO) "$(HACKT_ALLOC_TEST_PASSES)" | \
	  $(SPACESTONEWLINE) | $(SORT) -u | \
	  $(AWK) '{print $$1 ".alloc-from-haco-diff: " $$1 ".allocdump-filter"; }' > $@ ; \
	$(TOUCH) $@
endif

-include allocfromhaco.autodepend

.alloc-from-haco-diff.hacktallocfromhacotest:
	@$(DEFAULT_DIFF_TEST_SCRIPT)

.hacktallocfromhacotest:
	@$(DUMMY_TEST_SCRIPT)

AUTO_DEPENDS += alloctest.autodepend \
	allocfailtest.autodepend \
	allocfromhaco.autodepend

BOGUS_TESTS += .hacktallocfromhacotest .hacktalloctest .hacktallocfailtest
BOGUS_TARGETS += .allocstderr

CHECK_SUMMARIES += allocdiffs allocfaildiffs \
	allocfromhacodiffs allocdiffs.noindex


# this now includes 3-way differences
allocfromhacodiffs: force
	-$(CAT) *.alloc-from-haco-diff > $@

allocdiffs: force
	-$(CAT) *.allocdiff > $@

allocfaildiffs: force
	-$(CAT) *.allocfaildiff > $@

allocdiffs.noindex: force
	-$(CAT) *.allocdiff-noindex > $@


HACKT_ALLOC_TEST_SUBJECTS = \
	$(HACKT_ALLOC_TEST_PASSES) \
	$(HACKT_ALLOC_TEST_FAILURES)

srcdir_EXTRA_DIST += $(HACKT_ALLOC_TEST_SUBJECTS:=.allocstderr)


TESTS += \
	$(HACKT_ALLOC_TEST_PASSES:=.hacktalloctest) \
	$(HACKT_ALLOC_TEST_FAILURES:=.hacktallocfailtest) \
	$(HACKT_ALLOC_TEST_PASSES:=.hacktallocfromhacotest)

ALLOC_BUILD_CHECK_LOCAL = \
	$(HACKT_ALLOC_TEST_PASSES:=.haco-a) \
	$(HACKT_ALLOC_TEST_PASSES:=.allocdump) \
	$(HACKT_ALLOC_TEST_PASSES:=.allocdump-filter) \
	$(HACKT_ALLOC_TEST_PASSES:=.allocdiff) \
	$(HACKT_ALLOC_TEST_FAILURES:=.allocfaildump) \
	$(HACKT_ALLOC_TEST_FAILURES:=.allocfaildiff) \
	$(HACKT_ALLOC_TEST_PASSES:=.haco-a-from-haco) \
	$(HACKT_ALLOC_TEST_PASSES:=.alloc-from-haco-dump) \
	$(HACKT_ALLOC_TEST_PASSES:=.alloc-from-haco-dump-filter) \
	$(HACKT_ALLOC_TEST_PASSES:=.alloc-from-haco-diff)

if USE_UNROLL_PHASE
ALLOC_BUILD_CHECK_LOCAL += \
	$(HACKT_ALLOC_TEST_PASSES:=.haco-a-from-u) \
	$(HACKT_ALLOC_TEST_PASSES:=.alloc-from-u-dump) \
	$(HACKT_ALLOC_TEST_PASSES:=.alloc-from-u-dump-filter)
endif

build-check-local: $(ALLOC_BUILD_CHECK_LOCAL)

echo-alloc-passes: force
	@$(ECHO) $(HACKT_ALLOC_TEST_PASSES)

echo-alloc-failures: force
	@$(ECHO) $(HACKT_ALLOC_TEST_FAILURES)

echo-alloc-tests: force
	@$(ECHO) $(HACKT_ALLOC_TEST_SUBJECTS)


clean-alloctests:
	-$(RM_PATTERN) "*.hacktalloctest"
	-$(RM_PATTERN) "*.hacktallocfailtest"
	-$(RM_PATTERN) "*.hacktallocfromhacotest"
	-$(RM_PATTERN) "*.haco-a"
	-$(RM_PATTERN) "*.allocdump"
	-$(RM_PATTERN) "*.allocdump-filter"
	-$(RM_PATTERN) "*.allocdump.filter"
	-$(RM_PATTERN) "*.allocfaildump"
	-$(RM_PATTERN) "*.allocdiff"
	-$(RM_PATTERN) "*.allocfaildiff"
	-$(RM_PATTERN) "*.haco-a-dump"
	-$(RM_PATTERN) "*.alloc-from*"
	-$(RM_PATTERN) "*.prsimexpr-O1"
	-$(RM_PATTERN) "*.prs-dot-O1"

clean-local: clean-alloctests

.PHONY: clean-alloctests

