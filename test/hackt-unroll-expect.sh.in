#!@SH_PATH@
# "hackt-unroll-expect.sh.in"
#	$Id: hackt-unroll-expect.sh.in,v 1.2 2005/12/13 04:15:52 fang Exp $
# This file used to be:
#	Id: artobjunroll-expect.sh.in,v 1.5 2005/12/08 22:01:15 fang Exp
# This file came from "artobjunroll-expect.sh" in revision prehistory.

# $1 is the executable for the unroller, expecting 2 arguments
# $2 is the executable for reading in the object file, (probably hackt objdump)
#	and producing a textual dump to stderr.

# $3 is the path to the source directory, which is not necessarily ./
#	during distcheck uses _build
# $4 is the input file name WITHOUT the .in extension
# $5 is the filter for ignoring certain difference in output
#	(for no filter, pass "cat")
# $6 is the test report log file, summarizing results
# $7 is a difference analysis script to run on the objdump differences
#	AFTER the header filter has been run
# $8 is an additional index filter to be run on the objdump differences, 
##	but only after the primary header filter ($5) is run
# other subsequent arguments are ignored

# if test $# -lt 8 ; then exit 1 ; fi

unroll=$1
dump=$2
srcroot=$3/$4
bldroot=$4
filter=$5
logfile=$6
analdiff=$7
indfilter=$8

# an pre-unrolled object file must already exist
if test ! -s $bldroot.haco
then
	@ECHO@ "$bldroot.haco doesn't exist or is empty."
	exit 1
fi

$unroll $bldroot.haco $bldroot.haco-u > $bldroot.unrolldump 2>&1

# depending on exit status, take action
case $? in
	0) 
		$dump $bldroot.haco-u > $bldroot.unrolldump 2>&1
		break ;;
	1) break ;;
	*) exit 1 ;;
esac

@CAT@ $bldroot.unrolldump | $filter > $bldroot.unrolldump.filter

# .unrollstderr comparison file must exist
if test ! -f $srcroot.unrollstderr
then
	@ECHO@ "Missing $srcroot.unrollstderr."
	exit 1
fi

# ignore whitespace differences
@DIFF@ -buw $srcroot.unrollstderr $bldroot.unrolldump.filter 2>&1 | \
	@CAT@ > $bldroot.unrolldiff

if test -s $bldroot.unrolldiff
then
	@ECHO@ "$bldroot.unrolldiff is non-empty!  See $logfile."
	@ECHO@ `pwd`/"$bldroot.unrolldiff" >> $logfile
	$analdiff -v quiet=2 $bldroot.unrolldiff > $bldroot.unrollanal
	if @GREP@ "OK" $bldroot.unrollanal
	then
	# test may JUST be binary difference, we analyze more closely:
		@CAT@ $srcroot.unrollstderr | \
			$indfilter > $bldroot.unrollstderr.noindex
		@CAT@ $bldroot.unrolldump.filter | \
			$indfilter > $bldroot.unrolldump.noindex
		@DIFF@ -buw $bldroot.unrollstderr.noindex \
			$bldroot.unrolldump.noindex 2>&1 | \
			@CAT@ > $bldroot.unrolldiff.noindex
		$analdiff -v quiet=0 $bldroot.unrolldiff.noindex
	# else don't bother with further analysis
	fi
	rm -f $bldroot.unrollanal
	exit 1
fi

